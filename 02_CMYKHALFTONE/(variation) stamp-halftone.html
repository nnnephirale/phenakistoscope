<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stamp Halftone Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f1f2; -webkit-font-smoothing: antialiased; }
        input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; cursor: pointer; }
        .std-slider::-webkit-slider-runnable-track { height: 2px; background: #e5e7eb; border-radius: 2px; }
        .std-slider::-webkit-slider-thumb { height: 12px; width: 12px; border-radius: 50%; background: #111827; -webkit-appearance: none; margin-top: -5px; border: 2px solid #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
        .upload-zone { 
            @apply border-2 border-dashed border-slate-300 rounded-2xl p-6 text-center cursor-pointer transition-all;
        }
        .upload-zone:hover { @apply border-slate-400 bg-slate-50; }
        .upload-zone.has-image { @apply border-solid border-emerald-400 bg-emerald-50; }
        
        .stamp-preview {
            @apply w-16 h-16 rounded-lg border border-slate-200 bg-white flex items-center justify-center overflow-hidden;
        }
        .stamp-preview img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        #canvas-wrapper { 
            flex: 1; display: flex; align-items: center; justify-content: center; 
            overflow: hidden; cursor: grab; position: relative; background: #18181b;
        }
        #canvas-wrapper:active { cursor: grabbing; }
        
        canvas { box-shadow: 0 40px 80px -15px rgb(0 0 0 / 0.4); display: block; }
        
        .channel-row {
            @apply flex items-center gap-3 p-3 bg-white rounded-xl border border-slate-100 shadow-sm;
        }
        .channel-swatch {
            @apply w-4 h-4 rounded-full border border-black/10 flex-shrink-0;
        }
        
        .section-header {
            @apply text-[10px] font-black uppercase tracking-wider text-slate-400 mb-3;
        }
        
        .toggle-switch {
            @apply w-10 h-5 bg-slate-200 rounded-full relative cursor-pointer transition-colors;
        }
        .toggle-switch.active { @apply bg-emerald-500; }
        .toggle-switch::after {
            content: ''; position: absolute; top: 2px; left: 2px;
            width: 16px; height: 16px; background: white; border-radius: 50%;
            transition: transform 0.2s;
        }
        .toggle-switch.active::after { transform: translateX(20px); }
    </style>
</head>
<body class="flex h-screen w-screen overflow-hidden text-slate-900 font-medium text-[11px]">

    <aside class="w-80 flex-shrink-0 border-r border-slate-200 bg-white p-6 overflow-y-auto z-50 flex flex-col shadow-xl">
        <h1 class="text-[10px] font-black uppercase tracking-[0.3em] text-slate-400 mb-6 italic">Stamp Halftone</h1>
        
        <!-- Stamp Unit Upload -->
        <section class="mb-6">
            <div class="section-header">Stamp Unit</div>
            <label id="stamp-upload-zone" class="upload-zone block mb-3">
                <div id="stamp-placeholder" class="space-y-2">
                    <div class="text-2xl">üñºÔ∏è</div>
                    <div class="text-[10px] font-bold uppercase text-slate-500">Upload Stamp Image</div>
                    <div class="text-[9px] text-slate-400">PNG with transparency recommended</div>
                </div>
                <div id="stamp-preview-container" class="hidden flex-col items-center gap-2">
                    <img id="stamp-preview-img" class="max-h-20 rounded-lg">
                    <span class="text-[9px] text-emerald-600 font-bold uppercase">Stamp Loaded ‚úì</span>
                </div>
                <input id="stamp-upload" type="file" class="hidden" accept="image/*" />
            </label>
            
            <div class="space-y-3">
                <div class="space-y-1">
                    <div class="flex justify-between uppercase text-[10px] font-bold text-slate-500">
                        <span>Stamp Size</span><span id="stampSize-val">40</span>
                    </div>
                    <input type="range" id="stampSize" min="10" max="100" value="40" class="std-slider">
                </div>
                
                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                    <span class="text-[10px] font-bold uppercase text-slate-600">Remove BG</span>
                    <div id="toggle-removeBg" class="toggle-switch" onclick="toggleRemoveBg()"></div>
                </div>
                
                <div id="bg-removal-options" class="hidden space-y-2 p-3 bg-slate-50 rounded-xl">
                    <div class="space-y-1">
                        <div class="flex justify-between uppercase text-[9px] font-bold text-slate-400">
                            <span>Threshold</span><span id="bgThreshold-val">240</span>
                        </div>
                        <input type="range" id="bgThreshold" min="200" max="255" value="240" class="std-slider">
                    </div>
                </div>
            </div>
        </section>
        
        <div class="h-px bg-slate-100 mb-6"></div>
        
        <!-- Source Image Upload -->
        <section class="mb-6">
            <div class="section-header">Source Image</div>
            <label id="source-upload-zone" class="upload-zone block">
                <div id="source-placeholder" class="space-y-2">
                    <div class="text-2xl">üì∑</div>
                    <div class="text-[10px] font-bold uppercase text-slate-500">Upload Source Photo</div>
                    <div class="text-[9px] text-slate-400">The image to halftone</div>
                </div>
                <div id="source-preview-container" class="hidden flex-col items-center gap-2">
                    <img id="source-preview-img" class="max-h-20 rounded-lg">
                    <span class="text-[9px] text-emerald-600 font-bold uppercase">Source Loaded ‚úì</span>
                </div>
                <input id="source-upload" type="file" class="hidden" accept="image/*" />
            </label>
        </section>
        
        <div class="h-px bg-slate-100 mb-6"></div>
        
        <!-- CMYK Channel Controls -->
        <section class="mb-6">
            <div class="section-header">CMYK Channels</div>
            <div class="space-y-2">
                <div class="channel-row">
                    <div class="channel-swatch" style="background: #00FFFF;"></div>
                    <span class="flex-1 text-[10px] font-bold uppercase">Cyan</span>
                    <div id="toggle-c" class="toggle-switch active" onclick="toggleChannel('c')"></div>
                </div>
                <div class="channel-row">
                    <div class="channel-swatch" style="background: #FF00FF;"></div>
                    <span class="flex-1 text-[10px] font-bold uppercase">Magenta</span>
                    <div id="toggle-m" class="toggle-switch active" onclick="toggleChannel('m')"></div>
                </div>
                <div class="channel-row">
                    <div class="channel-swatch" style="background: #FFFF00;"></div>
                    <span class="flex-1 text-[10px] font-bold uppercase">Yellow</span>
                    <div id="toggle-y" class="toggle-switch active" onclick="toggleChannel('y')"></div>
                </div>
                <div class="channel-row">
                    <div class="channel-swatch" style="background: #000000;"></div>
                    <span class="flex-1 text-[10px] font-bold uppercase">Black</span>
                    <div id="toggle-k" class="toggle-switch active" onclick="toggleChannel('k')"></div>
                </div>
            </div>
        </section>
        
        <div class="h-px bg-slate-100 mb-6"></div>
        
        <!-- Halftone Settings -->
        <section class="mb-6">
            <div class="section-header">Halftone Settings</div>
            <div class="space-y-3">
                <div class="space-y-1">
                    <div class="flex justify-between uppercase text-[10px] font-bold text-slate-500">
                        <span>Grid Density</span><span id="density-val">60</span>
                    </div>
                    <input type="range" id="density" min="20" max="150" value="60" class="std-slider">
                </div>
                
                <div class="space-y-1">
                    <div class="flex justify-between uppercase text-[10px] font-bold text-slate-500">
                        <span>Size Variation</span><span id="sizeVariation-val">1.0</span>
                    </div>
                    <input type="range" id="sizeVariation" min="0" max="2" step="0.1" value="1.0" class="std-slider">
                </div>
                
                <div class="space-y-1">
                    <div class="flex justify-between uppercase text-[10px] font-bold text-slate-500">
                        <span>Opacity Variation</span><span id="opacityVariation-val">0.5</span>
                    </div>
                    <input type="range" id="opacityVariation" min="0" max="1" step="0.1" value="0.5" class="std-slider">
                </div>
                
                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                    <span class="text-[10px] font-bold uppercase text-slate-600">Rosette Angles</span>
                    <div id="toggle-rosette" class="toggle-switch active" onclick="toggleRosette()"></div>
                </div>
            </div>
        </section>
        
        <div class="h-px bg-slate-100 mb-6"></div>
        
        <!-- Paper -->
        <section class="mb-6">
            <div class="section-header">Paper Color</div>
            <div class="flex items-center gap-3">
                <input type="color" id="paperColor" value="#FFFFFF" class="w-10 h-10 rounded-lg border-2 border-slate-200 cursor-pointer">
                <span id="paperColorHex" class="text-[10px] font-mono uppercase text-slate-500">#FFFFFF</span>
            </div>
        </section>
        
        <div class="flex-1"></div>
        
        <button id="download-btn" class="w-full bg-slate-950 text-white text-[10px] font-black uppercase py-4 rounded-2xl active:scale-[0.98] transition-transform">
            Download Export
        </button>
    </aside>

    <main class="flex-1 flex flex-col relative">
        <div id="canvas-wrapper">
            <canvas id="mainCanvas"></canvas>
            <p id="placeholder" class="absolute pointer-events-none text-white/30 font-black uppercase text-sm">Upload stamp & source images</p>
        </div>
        
        <div class="fixed bottom-8 right-8 flex items-center bg-white/95 backdrop-blur shadow-2xl rounded-full px-2 py-1.5 border border-slate-200 z-50">
            <button id="z-in" class="p-2 hover:bg-slate-100 rounded-full font-bold text-slate-900">+</button>
            <button id="z-out" class="p-2 hover:bg-slate-100 rounded-full font-bold text-slate-900">‚àí</button>
            <div class="w-px h-6 bg-slate-100 mx-2"></div>
            <button id="z-fit" class="px-3 py-1 hover:bg-slate-100 rounded-full text-[10px] font-black">FIT</button>
            <div class="w-px h-6 bg-slate-100 mx-2"></div>
            <span id="zoom-display" class="text-[10px] font-bold text-slate-500 w-12 text-center">100%</span>
        </div>
        
        <div id="processing-indicator" class="hidden fixed top-4 right-4 bg-slate-900 text-white px-4 py-2 rounded-full text-[10px] font-bold uppercase">
            Processing...
        </div>
    </main>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        const wrapper = document.getElementById('canvas-wrapper');
        
        let stampBitmap = null;
        let stampProcessed = null; // The processed stamp (with BG removed if enabled)
        let sourceBitmap = null;
        let currentZoom = 1.0;
        let panX = 0, panY = 0;
        let isPanning = false, lastX, lastY;
        
        // Tinted stamp caches for each CMYK channel
        let tintedStamps = { c: null, m: null, y: null, k: null };
        
        const config = {
            stampSize: 40,
            removeBg: false,
            bgThreshold: 240,
            density: 60,
            sizeVariation: 1.0,
            opacityVariation: 0.5,
            useRosette: true,
            paperColor: '#FFFFFF',
            channels: {
                c: { enabled: true, angle: 15, color: [0, 255, 255] },
                m: { enabled: true, angle: 75, color: [255, 0, 255] },
                y: { enabled: true, angle: 0, color: [255, 255, 0] },
                k: { enabled: true, angle: 45, color: [0, 0, 0] }
            }
        };
        
        // --- STAMP PROCESSING ---
        
        function processStamp() {
            if (!stampBitmap) return;
            
            const size = config.stampSize;
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = size;
            tempCanvas.height = size;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Draw stamp scaled to target size
            const scale = Math.min(size / stampBitmap.width, size / stampBitmap.height);
            const w = stampBitmap.width * scale;
            const h = stampBitmap.height * scale;
            const x = (size - w) / 2;
            const y = (size - h) / 2;
            
            tempCtx.clearRect(0, 0, size, size);
            tempCtx.drawImage(stampBitmap, x, y, w, h);
            
            // Remove background if enabled
            if (config.removeBg) {
                const imageData = tempCtx.getImageData(0, 0, size, size);
                const data = imageData.data;
                const threshold = config.bgThreshold;
                
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i], g = data[i + 1], b = data[i + 2];
                    // Remove near-white pixels
                    if (r > threshold && g > threshold && b > threshold) {
                        data[i + 3] = 0; // Set alpha to 0
                    }
                }
                tempCtx.putImageData(imageData, 0, 0);
            }
            
            stampProcessed = tempCanvas;
            generateTintedStamps();
        }
        
        function generateTintedStamps() {
            if (!stampProcessed) return;
            
            const size = config.stampSize;
            
            ['c', 'm', 'y', 'k'].forEach(channel => {
                const tintCanvas = document.createElement('canvas');
                tintCanvas.width = size;
                tintCanvas.height = size;
                const tintCtx = tintCanvas.getContext('2d');
                
                // Draw the processed stamp
                tintCtx.drawImage(stampProcessed, 0, 0);
                
                // Apply color tint using multiply blend
                tintCtx.globalCompositeOperation = 'source-atop';
                const [r, g, b] = config.channels[channel].color;
                tintCtx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                tintCtx.fillRect(0, 0, size, size);
                
                tintedStamps[channel] = tintCanvas;
            });
            
            render();
        }
        
        // --- CMYK CONVERSION ---
        
        function rgbToCmyk(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const k = 1 - Math.max(r, g, b);
            if (k === 1) return { c: 0, m: 0, y: 0, k: 1 };
            return {
                c: (1 - r - k) / (1 - k),
                m: (1 - g - k) / (1 - k),
                y: (1 - b - k) / (1 - k),
                k: k
            };
        }
        
        // --- MAIN RENDER ---
        
        function render() {
            const baseW = sourceBitmap ? sourceBitmap.width : 800;
            const baseH = sourceBitmap ? sourceBitmap.height : 600;
            
            canvas.width = baseW;
            canvas.height = baseH;
            canvas.style.width = `${baseW * currentZoom}px`;
            canvas.style.height = `${baseH * currentZoom}px`;
            
            // Fill paper
            ctx.fillStyle = config.paperColor;
            ctx.fillRect(0, 0, baseW, baseH);
            
            if (!sourceBitmap || !stampProcessed) {
                updateTransform();
                return;
            }
            
            document.getElementById('placeholder').style.display = 'none';
            
            // Get source image data
            const srcCanvas = document.createElement('canvas');
            srcCanvas.width = baseW;
            srcCanvas.height = baseH;
            const srcCtx = srcCanvas.getContext('2d');
            srcCtx.drawImage(sourceBitmap, 0, 0);
            const srcData = srcCtx.getImageData(0, 0, baseW, baseH).data;
            
            // Calculate grid
            const gridStep = baseW / config.density;
            const diag = Math.sqrt(baseW * baseW + baseH * baseH);
            const stampSize = config.stampSize;
            const halfStamp = stampSize / 2;
            
            // Set multiply blend for overprinting effect
            ctx.globalCompositeOperation = 'multiply';
            
            // Render each channel
            ['c', 'm', 'y', 'k'].forEach(channelId => {
                const channel = config.channels[channelId];
                if (!channel.enabled || !tintedStamps[channelId]) return;
                
                const angle = config.useRosette ? channel.angle * (Math.PI / 180) : 0;
                const cosA = Math.cos(angle);
                const sinA = Math.sin(angle);
                
                for (let gx = -diag; gx < diag; gx += gridStep) {
                    for (let gy = -diag; gy < diag; gy += gridStep) {
                        // Rotate grid point
                        const x = gx * cosA - gy * sinA + baseW / 2;
                        const y = gx * sinA + gy * cosA + baseH / 2;
                        
                        if (x < -halfStamp || x >= baseW + halfStamp || 
                            y < -halfStamp || y >= baseH + halfStamp) continue;
                        
                        // Sample source at this position
                        const sampleX = Math.floor(Math.max(0, Math.min(baseW - 1, x)));
                        const sampleY = Math.floor(Math.max(0, Math.min(baseH - 1, y)));
                        const i = (sampleY * baseW + sampleX) * 4;
                        
                        const cmyk = rgbToCmyk(srcData[i], srcData[i + 1], srcData[i + 2]);
                        const density = cmyk[channelId];
                        
                        if (density < 0.02) continue;
                        
                        // Calculate stamp size based on density
                        const sizeMultiplier = config.sizeVariation > 0 
                            ? Math.pow(density, 1 / (config.sizeVariation + 0.5))
                            : 1;
                        const drawSize = stampSize * sizeMultiplier;
                        
                        // Calculate opacity based on density
                        const opacity = config.opacityVariation > 0
                            ? Math.pow(density, config.opacityVariation)
                            : density;
                        
                        ctx.globalAlpha = Math.min(1, opacity);
                        
                        // Draw tinted stamp
                        ctx.drawImage(
                            tintedStamps[channelId],
                            x - drawSize / 2,
                            y - drawSize / 2,
                            drawSize,
                            drawSize
                        );
                    }
                }
            });
            
            ctx.globalAlpha = 1.0;
            ctx.globalCompositeOperation = 'source-over';
            updateTransform();
        }
        
        // --- UI HELPERS ---
        
        function getFitScale() {
            if (!sourceBitmap) return 1.0;
            const pad = 80;
            return Math.min(
                (wrapper.clientWidth - pad) / sourceBitmap.width,
                (wrapper.clientHeight - pad) / sourceBitmap.height
            );
        }
        
        function updateTransform() {
            canvas.style.transform = `translate(${panX}px, ${panY}px)`;
            const fitScale = getFitScale();
            const pct = Math.round(currentZoom * 100);
            document.getElementById('zoom-display').textContent = `${pct}%`;
        }
        
        function toggleChannel(id) {
            config.channels[id].enabled = !config.channels[id].enabled;
            document.getElementById(`toggle-${id}`).classList.toggle('active');
            render();
        }
        
        function toggleRemoveBg() {
            config.removeBg = !config.removeBg;
            document.getElementById('toggle-removeBg').classList.toggle('active');
            document.getElementById('bg-removal-options').classList.toggle('hidden', !config.removeBg);
            processStamp();
        }
        
        function toggleRosette() {
            config.useRosette = !config.useRosette;
            document.getElementById('toggle-rosette').classList.toggle('active');
            render();
        }
        
        function showProcessing(show) {
            document.getElementById('processing-indicator').classList.toggle('hidden', !show);
        }
        
        // --- EVENT LISTENERS ---
        
        // Stamp upload
        document.getElementById('stamp-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            showProcessing(true);
            stampBitmap = await createImageBitmap(file);
            
            // Update preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('stamp-preview-img').src = e.target.result;
                document.getElementById('stamp-placeholder').classList.add('hidden');
                document.getElementById('stamp-preview-container').classList.remove('hidden');
                document.getElementById('stamp-preview-container').classList.add('flex');
                document.getElementById('stamp-upload-zone').classList.add('has-image');
            };
            reader.readAsDataURL(file);
            
            processStamp();
            showProcessing(false);
        });
        
        // Source upload
        document.getElementById('source-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            showProcessing(true);
            sourceBitmap = await createImageBitmap(file);
            
            // Update preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('source-preview-img').src = e.target.result;
                document.getElementById('source-placeholder').classList.add('hidden');
                document.getElementById('source-preview-container').classList.remove('hidden');
                document.getElementById('source-preview-container').classList.add('flex');
                document.getElementById('source-upload-zone').classList.add('has-image');
            };
            reader.readAsDataURL(file);
            
            currentZoom = getFitScale();
            panX = 0;
            panY = 0;
            render();
            showProcessing(false);
        });
        
        // Sliders
        document.getElementById('stampSize').addEventListener('input', (e) => {
            config.stampSize = parseInt(e.target.value);
            document.getElementById('stampSize-val').textContent = config.stampSize;
            processStamp();
        });
        
        document.getElementById('bgThreshold').addEventListener('input', (e) => {
            config.bgThreshold = parseInt(e.target.value);
            document.getElementById('bgThreshold-val').textContent = config.bgThreshold;
            processStamp();
        });
        
        document.getElementById('density').addEventListener('input', (e) => {
            config.density = parseInt(e.target.value);
            document.getElementById('density-val').textContent = config.density;
            render();
        });
        
        document.getElementById('sizeVariation').addEventListener('input', (e) => {
            config.sizeVariation = parseFloat(e.target.value);
            document.getElementById('sizeVariation-val').textContent = config.sizeVariation.toFixed(1);
            render();
        });
        
        document.getElementById('opacityVariation').addEventListener('input', (e) => {
            config.opacityVariation = parseFloat(e.target.value);
            document.getElementById('opacityVariation-val').textContent = config.opacityVariation.toFixed(1);
            render();
        });
        
        document.getElementById('paperColor').addEventListener('input', (e) => {
            config.paperColor = e.target.value;
            document.getElementById('paperColorHex').textContent = config.paperColor.toUpperCase();
            render();
        });
        
        // Zoom controls
        document.getElementById('z-in').addEventListener('click', () => {
            currentZoom *= 1.25;
            render();
        });
        
        document.getElementById('z-out').addEventListener('click', () => {
            currentZoom *= 0.8;
            render();
        });
        
        document.getElementById('z-fit').addEventListener('click', () => {
            currentZoom = getFitScale();
            panX = 0;
            panY = 0;
            render();
        });
        
        // Panning
        wrapper.addEventListener('mousedown', (e) => {
            if (e.target === canvas || e.target === wrapper) {
                isPanning = true;
                lastX = e.clientX;
                lastY = e.clientY;
            }
        });
        
        window.addEventListener('mousemove', (e) => {
            if (!isPanning) return;
            panX += e.clientX - lastX;
            panY += e.clientY - lastY;
            lastX = e.clientX;
            lastY = e.clientY;
            updateTransform();
        });
        
        window.addEventListener('mouseup', () => {
            isPanning = false;
        });
        
        // Download
        document.getElementById('download-btn').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'stamp-halftone.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
        
        // Initial render
        window.addEventListener('load', () => {
            currentZoom = getFitScale();
            render();
        });
        
        window.addEventListener('resize', () => {
            currentZoom = getFitScale();
            render();
        });
    </script>
</body>
</html>

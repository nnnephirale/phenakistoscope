<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halftone Studio v5.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f1f2; -webkit-font-smoothing: antialiased; }
        input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; cursor: pointer; }
        input[type=range]:focus { outline: none; }
        
        .std-slider::-webkit-slider-runnable-track { height: 2px; background: #e5e7eb; border-radius: 2px; }
        .std-slider::-webkit-slider-thumb { height: 12px; width: 12px; border-radius: 50%; background: #111827; -webkit-appearance: none; margin-top: -5px; border: 2px solid #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }

        .collapsible-content { transition: max-height 0.3s ease-in-out; overflow: hidden; }
        .collapsed .collapsible-content { max-height: 0 !important; }
        .collapsed .toggle-arrow { transform: rotate(-90deg); }

        .color-card { @apply bg-white border border-slate-100 rounded-xl p-3 flex items-center gap-3 cursor-pointer hover:bg-slate-50 transition-all shadow-sm; }
        
        #preview-container { display: flex; flex-direction: column; overflow: hidden; background-color: #f4f4f5; width: 100%; height: 100%; position: relative; }
        /* Centering Fix: ensure wrapper allows the canvas to sit in middle */
        #canvas-wrapper { flex: 1; display: flex; align-items: center; justify-content: center; overflow: auto; padding: 100px; cursor: grab; }
        #canvas-wrapper:active { cursor: grabbing; }
        canvas { box-shadow: 0 40px 80px -15px rgb(0 0 0 / 0.4); display: block; background-color: #000; }

        #floating-settings { 
            position: fixed; z-index: 1000; display: none;
            background: white; border-radius: 16px; 
            width: 280px; padding: 16px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0; pointer-events: auto;
        }
        #floating-settings.active { display: block; }

        #m-hue { height: 14px; border-radius: 7px; background: linear-gradient(to right, #f00 0%, #ff0 17%, #0f0 33%, #0ff 50%, #00f 67%, #f0f 83%, #f00 100%); }
        #m-hue::-webkit-slider-thumb { 
            -webkit-appearance: none; appearance: none;
            height: 18px; width: 18px; border-radius: 50%;
            background: transparent; border: 2px solid rgba(100, 116, 139, 0.5);
            margin-top: -2px; 
        }
        #m-hue::-webkit-slider-runnable-track { background: none; }
        #sb-cursor { width: 12px; height: 12px; border: 2px solid white; border-radius: 50%; position: absolute; transform: translate(-50%, -50%); box-shadow: 0 1px 3px rgba(0,0,0,0.3); pointer-events: none; }
    </style>
</head>
<body class="flex h-screen w-screen overflow-hidden text-slate-900 font-medium text-[11px]">

    <div id="floating-settings" class="space-y-3">
        <div class="flex items-center justify-between">
            <span id="m-title" class="font-bold uppercase text-[10px] text-slate-500">Cyan</span>
             <div class="flex items-center gap-1 bg-slate-100 rounded-md px-1.5 py-0.5">
                <span class="text-[8px] font-bold text-slate-400">HEX</span>
                <input type="text" id="m-hex" class="bg-transparent text-[10px] font-mono outline-none w-12 text-center uppercase">
            </div>
        </div>
        <input type="range" id="m-hue" min="0" max="360" class="w-full">
        <div id="sb-picker" class="w-full h-32 rounded-lg relative cursor-crosshair shadow-sm" style="background: linear-gradient(to top, #000, transparent), linear-gradient(to right, #fff, hsl(0, 100%, 50%))">
            <div id="sb-cursor" class="absolute"></div>
        </div>
        <div class="flex gap-2">
            <div class="flex-1 flex items-center gap-1 border border-slate-200 rounded-md px-1.5 py-0.5">
                <span class="text-[8px] font-bold text-slate-400">H</span>
                <input type="number" id="m-h-input" min="0" max="360" class="w-full bg-transparent text-[10px] font-mono outline-none text-center">
            </div>
            <div class="flex-1 flex items-center gap-1 border border-slate-200 rounded-md px-1.5 py-0.5">
                <span class="text-[8px] font-bold text-slate-400">S</span>
                <input type="number" id="m-s-input" min="0" max="100" class="w-full bg-transparent text-[10px] font-mono outline-none text-center">
            </div>
            <div class="flex-1 flex items-center gap-1 border border-slate-200 rounded-md px-1.5 py-0.5">
                <span class="text-[8px] font-bold text-slate-400">B</span>
                <input type="number" id="m-b-input" min="0" max="100" class="w-full bg-transparent text-[10px] font-mono outline-none text-center">
            </div>
        </div>
        <div class="space-y-3 pt-2 border-t border-slate-100">
            <div class="space-y-1">
                <div class="flex justify-between uppercase font-bold text-slate-500 text-[9px]"><span>Ink Strength</span><span id="m-str-val">1.00</span></div>
                <input type="range" id="m-str" min="0" max="1.0" step="0.05" class="std-slider">
            </div>
            <div class="space-y-1" id="opa-container">
                <div class="flex justify-between uppercase font-bold text-slate-500 text-[9px]"><span>Ink Opacity</span><span id="m-opa-val">1.00</span></div>
                <input type="range" id="m-opa" min="0" max="1.0" step="0.01" class="std-slider">
            </div>
        </div>
    </div>

    <aside class="w-80 flex-shrink-0 border-r border-slate-200 bg-white p-6 overflow-y-auto z-50 flex flex-col shadow-xl">
        <h1 class="text-[10px] font-black uppercase tracking-[0.4em] text-slate-400 mb-8 italic">Halftone Studio</h1>
        <label class="mb-8 group flex flex-col items-center justify-center w-full h-16 border-2 border-dashed border-slate-200 rounded-2xl cursor-pointer hover:border-slate-400 hover:bg-slate-50 transition-all">
            <span class="text-[10px] font-bold uppercase text-slate-500 tracking-wider">Upload Base Image</span>
            <input id="img-upload" type="file" class="hidden" accept="image/*" />
        </label>

        <div class="space-y-4 flex-1">
            <section id="sec-base" class="collapsed border-b border-slate-100 pb-2">
                <button onclick="toggleSection('sec-base')" class="flex items-center justify-between w-full py-2 group">
                    <h2 class="text-[10px] font-black uppercase tracking-widest text-slate-400 group-hover:text-slate-900 transition-colors">Base Image</h2>
                    <svg class="toggle-arrow w-3 h-3 transition-transform text-slate-300 group-hover:text-slate-900" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div class="collapsible-content space-y-4 pt-2">
                    <div class="space-y-1">
                        <div class="flex justify-between uppercase"><span>Blur</span><span id="blur-val">0</span></div>
                        <input type="range" id="blur" min="0" max="10" step="0.5" value="0" class="std-slider">
                    </div>
                    <div class="space-y-1">
                        <div class="flex justify-between uppercase"><span>Shadow Offset</span><span id="shadows-val">0.00</span></div>
                        <input type="range" id="shadows" min="-0.5" max="0.5" step="0.01" value="0" class="std-slider">
                    </div>
                    <div class="space-y-1">
                        <div class="flex justify-between uppercase"><span>Highlight Offset</span><span id="highlights-val">1.00</span></div>
                        <input type="range" id="highlights" min="0.5" max="1.5" step="0.01" value="1.0" class="std-slider">
                    </div>
                    <div class="space-y-1">
                        <div class="flex justify-between uppercase"><span>Contrast</span><span id="contrast-val">1.0</span></div>
                        <input type="range" id="contrast" min="0.5" max="2.0" step="0.1" value="1.0" class="std-slider">
                    </div>
                </div>
            </section>

            <section id="sec-palette" class="border-b border-slate-100 pb-2">
                <button onclick="toggleSection('sec-palette')" class="flex items-center justify-between w-full py-2 group">
                    <h2 class="text-[10px] font-black uppercase tracking-widest text-slate-400 group-hover:text-slate-900 transition-colors">Palette & Strength</h2>
                    <svg class="toggle-arrow w-3 h-3 transition-transform text-slate-300 group-hover:text-slate-900" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div class="collapsible-content pt-4 space-y-2.5">
                    <div class="grid grid-cols-2 gap-2">
                        <div class="color-card" onclick="openAnchoredSettings(this, 'c')"><div id="sw-c" class="w-3.5 h-3.5 rounded bg-[#00ffff] border border-black/5"></div><span class="text-[9px] font-black uppercase">Cyan</span></div>
                        <div class="color-card" onclick="openAnchoredSettings(this, 'm')"><div id="sw-m" class="w-3.5 h-3.5 rounded bg-[#ff00ff] border border-black/5"></div><span class="text-[9px] font-black uppercase">Mag</span></div>
                        <div class="color-card" onclick="openAnchoredSettings(this, 'y')"><div id="sw-y" class="w-3.5 h-3.5 rounded bg-[#ffff00] border border-black/5"></div><span class="text-[9px] font-black uppercase">Yel</span></div>
                        <div class="color-card" onclick="openAnchoredSettings(this, 'k')"><div id="sw-k" class="w-3.5 h-3.5 rounded bg-[#000000] border border-black/5"></div><span class="text-[9px] font-black uppercase">Black</span></div>
                    </div>
                    <div class="color-card" onclick="openAnchoredSettings(this, 'paper')"><div id="sw-paper" class="w-3.5 h-3.5 rounded bg-[#fdfaf0] border border-slate-200"></div><span class="text-[9px] font-black uppercase tracking-tight">Paper Stock</span></div>
                </div>
            </section>

            <section id="sec-physics" class="pb-2">
                <button onclick="toggleSection('sec-physics')" class="flex items-center justify-between w-full py-2 group">
                    <h2 class="text-[10px] font-black uppercase tracking-widest text-slate-400 group-hover:text-slate-900 transition-colors">Halftone Physics</h2>
                    <svg class="toggle-arrow w-3 h-3 transition-transform text-slate-300 group-hover:text-slate-900" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div class="collapsible-content space-y-4 pt-2">
                    <div class="flex items-center justify-between bg-slate-50 p-2.5 rounded-xl border border-slate-100">
                        <span class="font-bold uppercase text-slate-700">Fill Highlights</span>
                        <input id="forceMinDot" type="checkbox" class="w-7 h-4 bg-slate-200 checked:bg-slate-900 rounded-full appearance-none cursor-pointer transition-colors relative after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all checked:after:translate-x-3"/>
                    </div>
                    <div class="space-y-1">
                        <div class="text-[9px] font-black text-slate-400 uppercase mb-1">Ink Bleed</div>
                        <select id="inkBleed" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 font-bold outline-none cursor-pointer uppercase">
                            <option value="0">None</option><option value="0.1">Subtle</option><option value="0.2">Moderate</option><option value="0.3">Strong</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <div class="flex justify-between uppercase"><span>Resolution</span><span id="frequency-val">85</span></div>
                        <input type="range" id="frequency" min="30" max="200" value="85" class="std-slider">
                    </div>
                    <div class="space-y-1">
                        <div class="flex justify-between uppercase"><span>Size Curve</span><span id="dotContrast-val">1.00</span></div>
                        <input type="range" id="dotContrast" min="0.5" max="3.0" step="0.1" value="1.0" class="std-slider">
                    </div>
                    <div class="space-y-1">
                        <div class="flex justify-between uppercase"><span>Global Scale</span><span id="dotScale-val">1.00</span></div>
                        <input type="range" id="dotScale" min="0.1" max="3.0" step="0.1" value="1.0" class="std-slider">
                    </div>
                </div>
            </section>
        </div>
        <button id="download-btn" class="mt-8 w-full bg-slate-950 text-white text-[10px] font-black uppercase tracking-[0.2em] py-4 rounded-2xl hover:bg-black transition-all shadow-xl active:scale-[0.98]">Download Export</button>
    </aside>

    <main class="flex-1 relative" id="preview-container">
        <div id="canvas-wrapper">
            <canvas id="mainCanvas"></canvas>
            <p id="placeholder" class="absolute pointer-events-none text-white/50 mix-blend-difference font-black uppercase tracking-[0.3em] text-[10px]">Workspace Empty</p>
        </div>

        <div class="fixed bottom-8 right-8 flex items-center bg-white/95 backdrop-blur shadow-2xl rounded-full px-2 py-1.5 border border-slate-200 z-50">
            <button id="z-in" class="p-2 hover:bg-slate-100 rounded-full text-slate-900 transition-colors">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </button>
            <button id="z-out" class="p-2 hover:bg-slate-100 rounded-full text-slate-400 hover:text-slate-900 transition-colors">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </button>
            <div class="w-[1px] h-6 bg-slate-100 mx-2"></div>
            <div class="relative flex items-center group">
                <select id="z-sel" class="bg-transparent text-[10px] font-black uppercase tracking-widest pl-2 pr-6 py-1 appearance-none cursor-pointer focus:outline-none text-slate-700">
                    <option value="0.5">50%</option><option value="0.75">75%</option>
                    <option value="1" selected>FIT</option><option value="2">200%</option><option value="4">400%</option>
                </select>
                <svg class="absolute right-1 w-3 h-3 pointer-events-none text-slate-400 group-hover:text-slate-900" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path d="M19 9l-7 7-7-7"></path></svg>
            </div>
            <div class="w-[1px] h-6 bg-slate-100 mx-2"></div>
            <button id="z-fit" class="p-2 hover:bg-slate-100 rounded-full text-slate-400 hover:text-slate-900 transition-colors">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="M9 3v6H3M15 3v6h6M9 21v-6H3M15 21v-6h6"></path></svg>
            </button>
        </div>
    </main>

    <script>
        const canvas = document.getElementById('mainCanvas'), ctx = canvas.getContext('2d', { alpha: false });
        const container = document.getElementById('canvas-wrapper'), zoomSelect = document.getElementById('z-sel');
        let sourceBitmap = null, currentZoom = 1.0, activeChannel = 'c';
        let isDragging = false, startX, startY, scrollLeft, scrollTop;

        // Color Picker Elements
        const sbPicker = document.getElementById('sb-picker');
        const sbCursor = document.getElementById('sb-cursor');
        const mHue = document.getElementById('m-hue');
        const mHex = document.getElementById('m-hex');
        const mHInput = document.getElementById('m-h-input'), mSInput = document.getElementById('m-s-input'), mBInput = document.getElementById('m-b-input');
        const mStr = document.getElementById('m-str'), mOpa = document.getElementById('m-opa');
        const mStrVal = document.getElementById('m-str-val'), mOpaVal = document.getElementById('m-opa-val');
        const opaContainer = document.getElementById('opa-container');

        let pickerHSB = { h: 0, s: 0, b: 0 };
        let isDraggingSB = false;

        const config = { 
            blur: 0, shadows: 0, highlights: 1.0, contrast: 1.0, dotContrast: 1.0, frequency: 85, dotScale: 1.0, inkBleed: 0, forceMinDot: false,
            paper: { id: 'paper', hex: "#fdfaf0", h: 50, s: 6, b: 99 },
            channels: {
                c: { id: 'c', hex: "#00ffff", h: 180, s: 100, b: 100, limit: 1.0, opacity: 0.95, ang: 15 },
                m: { id: 'm', hex: "#ff00ff", h: 300, s: 100, b: 100, limit: 1.0, opacity: 0.95, ang: 75 },
                y: { id: 'y', hex: "#ffff00", h: 60, s: 100, b: 100, limit: 1.0, opacity: 0.95, ang: 0 },
                k: { id: 'k', hex: "#000000", h: 0, s: 0, b: 0, limit: 0.5, opacity: 0.95, ang: 45 }
            }
        };

        function toggleSection(id) { document.getElementById(id).classList.toggle('collapsed'); }
        function hsbToHex(h, s, b) { b /= 100; s /= 100; const k = n => (n + h / 60) % 6, f = n => b * (1 - s * Math.max(0, Math.min(k(n), 4 - k(n), 1))); return "#" + [f(5), f(3), f(1)].map(x => Math.round(x * 255).toString(16).padStart(2, '0')).join(''); }
        function hexToHsb(hex) { let r = parseInt(hex.slice(1,3), 16)/255, g = parseInt(hex.slice(3,5), 16)/255, b = parseInt(hex.slice(5,7), 16)/255, v = Math.max(r,g,b), n = v - Math.min(r,g,b), h = n && (v==r ? (g-b)/n : v==g ? 2+(b-r)/n : 4+(r-g)/n); return { h: Math.round(60*(h<0?h+6:h)), s: Math.round(v&&(n/v)*100), b: Math.round(v*100) }; }

        function openAnchoredSettings(el, chan) {
            activeChannel = chan;
            const data = chan === 'paper' ? config.paper : config.channels[chan];
            const popup = document.getElementById('floating-settings');
            const rect = el.getBoundingClientRect();
            
            popup.style.top = `${Math.max(20, Math.min(window.innerHeight - popup.offsetHeight - 20, rect.top))}px`;
            popup.style.left = `${rect.right + 15}px`;
            
            document.getElementById('m-title').textContent = chan === 'paper' ? 'Paper' : chan;
            pickerHSB = { h: data.h, s: data.s, b: data.b };
            opaContainer.style.display = chan === 'paper' ? 'none' : 'block';

            if(chan !== 'paper') {
                mStr.value = data.limit; mOpa.value = data.opacity;
                mStrVal.textContent = data.limit.toFixed(2); mOpaVal.textContent = data.opacity.toFixed(2);
            } else { mStr.value = 1.0; mStrVal.textContent = "1.00"; }

            popup.classList.add('active');
            updatePickerUI();
        }

        function closeSettings() { document.getElementById('floating-settings').classList.remove('active'); }

        function updatePickerUI() {
            const { h, s, b } = pickerHSB;
            const hex = hsbToHex(h, s, b);
            const data = activeChannel === 'paper' ? config.paper : config.channels[activeChannel];

            data.h = h; data.s = s; data.b = b; data.hex = hex;
            if(activeChannel !== 'paper') {
                data.limit = parseFloat(mStr.value); data.opacity = parseFloat(mOpa.value);
            }

            sbPicker.style.background = `linear-gradient(to top, #000, transparent), linear-gradient(to right, #fff, hsl(${h}, 100%, 50%))`;
            sbCursor.style.left = `${s}%`; sbCursor.style.top = `${100 - b}%`; sbCursor.style.backgroundColor = hex;
            mHue.value = h; mHex.value = hex.substring(1).toUpperCase();
            mHInput.value = Math.round(h); mSInput.value = Math.round(s); mBInput.value = Math.round(b);
            document.getElementById(`sw-${activeChannel}`).style.backgroundColor = hex;
            render();
        }

        sbPicker.addEventListener('mousedown', (e) => { isDraggingSB = true; handleSBMouse(e); });
        document.addEventListener('mousemove', (e) => { if (isDraggingSB) handleSBMouse(e); });
        document.addEventListener('mouseup', () => { isDraggingSB = false; });

        function handleSBMouse(e) {
            const rect = sbPicker.getBoundingClientRect();
            let x = e.clientX - rect.left; let y = e.clientY - rect.top;
            x = Math.max(0, Math.min(x, rect.width)); y = Math.max(0, Math.min(y, rect.height));
            pickerHSB.s = (x / rect.width) * 100; pickerHSB.b = 100 - (y / rect.height) * 100;
            updatePickerUI();
        }

        mHue.addEventListener('input', (e) => { pickerHSB.h = parseFloat(e.target.value); updatePickerUI(); });
        [mHInput, mSInput, mBInput].forEach(input => {
            input.addEventListener('input', () => {
                pickerHSB.h = parseFloat(mHInput.value) || 0; pickerHSB.s = parseFloat(mSInput.value) || 0; pickerHSB.b = parseFloat(mBInput.value) || 0;
                updatePickerUI();
            });
        });

        mStr.addEventListener('input', (e) => { mStrVal.textContent = parseFloat(e.target.value).toFixed(2); updatePickerUI(); });
        mOpa.addEventListener('input', (e) => { mOpaVal.textContent = parseFloat(e.target.value).toFixed(2); updatePickerUI(); });
        mHex.addEventListener('change', (e) => {
            let hex = e.target.value.trim(); if(!hex.startsWith('#')) hex = '#' + hex;
            if(/^#[0-9A-F]{6}$/i.test(hex)) { pickerHSB = hexToHsb(hex); updatePickerUI(); }
        });

        document.addEventListener('mousedown', (e) => {
            const popup = document.getElementById('floating-settings');
            if (popup.classList.contains('active') && !popup.contains(e.target) && !e.target.closest('.color-card')) closeSettings();
        });

        ['blur', 'shadows', 'highlights', 'contrast', 'dotContrast', 'frequency', 'dotScale', 'inkBleed'].forEach(k => {
            document.getElementById(k).oninput = (e) => { config[k] = parseFloat(e.target.value); if(document.getElementById(`${k}-val`)) document.getElementById(`${k}-val`).textContent = config[k].toFixed(2); render(); };
        });
        document.getElementById('forceMinDot').onchange = (e) => { config.forceMinDot = e.target.checked; render(); };

        /**
         * CORRECTION 3: ZOOM DISPLAY VALUE FIX
         */
        const updateZoom = (v) => { 
            currentZoom = parseFloat(v); 
            
            // UI Sync: update the select dropdown to match manual changes
            const found = Array.from(zoomSelect.options).find(o => Math.abs(parseFloat(o.value) - currentZoom) < 0.01); 
            if(found) zoomSelect.value = found.value; 
            else { 
                let c = document.getElementById('custom-zoom-opt'); 
                if(!c) { c = document.createElement('option'); c.id='custom-zoom-opt'; zoomSelect.appendChild(c); } 
                c.value = v; c.textContent = `${Math.round(v * 100)}%`; zoomSelect.value = v; 
            }
            render(); 
        };

        document.getElementById('z-in').onclick = () => updateZoom(currentZoom + 0.25);
        document.getElementById('z-out').onclick = () => updateZoom(Math.max(0.1, currentZoom - 0.25));
        document.getElementById('z-fit').onclick = () => updateZoom(1.0);
        zoomSelect.onchange = (e) => updateZoom(e.target.value);

        container.onmousedown = (e) => { isDragging = true; startX = e.clientX; startY = e.clientY; scrollLeft = container.scrollLeft; scrollTop = container.scrollTop; };
        window.onmousemove = (e) => { if(!isDragging) return; container.scrollLeft = scrollLeft - (e.clientX - startX); container.scrollTop = scrollTop - (e.clientY - startY); };
        window.onmouseup = () => isDragging = false;

        document.getElementById('img-upload').onchange = async (e) => { const file = e.target.files[0]; if(!file) return; sourceBitmap = await createImageBitmap(file); document.getElementById('placeholder').style.display='none'; render(); };

        /**
         * CORRECTION 1: INITIAL CENTERING + CORRECTION 2: INK BLEED FIX
         */
        function render() {
            // Default dimensions for black canvas if no image uploaded
            const defaultW = 800, defaultH = 600;
            const pad = 200, sideW = 320;
            const maxW = window.innerWidth - sideW - 100, maxH = window.innerHeight - 100;

            let baseW = defaultW, baseH = defaultH;

            if (sourceBitmap) {
                const aspect = sourceBitmap.width / sourceBitmap.height;
                baseW = maxW; baseH = maxW / aspect;
                if (baseH > maxH) { baseH = maxH; baseW = maxH * aspect; }
            }

            const dw = baseW * currentZoom, dh = baseH * currentZoom;
            canvas.width = dw; canvas.height = dh;

            // Start drawing
            ctx.fillStyle = config.paper.hex; ctx.fillRect(0, 0, dw, dh);
            if (!sourceBitmap) return; // Stop here for initial blank state

            const buffer = document.createElement('canvas'); buffer.width = dw; buffer.height = dh;
            const bCtx = buffer.getContext('2d');
            if (config.blur > 0) bCtx.filter = `blur(${config.blur * currentZoom}px)`;
            bCtx.drawImage(sourceBitmap, 0, 0, dw, dh);
            const imgData = bCtx.getImageData(0, 0, dw, dh).data;

            ctx.globalCompositeOperation = 'multiply';
            const gridStep = baseW / config.frequency * currentZoom;
            const diag = Math.sqrt(dw**2 + dh**2), gamma = 1.2, c_low = config.shadows, c_diff = config.highlights - config.shadows, c_cont = config.contrast * gamma;

            Object.values(config.channels).forEach(ink => {
                ctx.globalAlpha = ink.opacity; ctx.fillStyle = ink.hex;
                const rad = ink.ang * (Math.PI / 180), cosA = Math.cos(rad), sinA = Math.sin(rad);

                for (let gx = -diag; gx < diag; gx += gridStep) {
                    for (let gy = -diag; gy < diag; gy += gridStep) {
                        const x = gx * cosA - gy * sinA + dw/2, y = gx * sinA + gy * cosA + dh/2;
                        if (x >= 0 && x < dw && y >= 0 && y < dh) {
                            const i = (Math.floor(y) * Math.floor(dw) + Math.floor(x)) * 4;
                            const apply = v => Math.max(0, Math.min(1, (v/255 - c_low) / c_diff));
                            const r = Math.pow(apply(imgData[i]), c_cont), g = Math.pow(apply(imgData[i+1]), c_cont), b = Math.pow(apply(imgData[i+2]), c_cont);
                            const k = 1 - Math.max(r, g, b);
                            let val = ink.id === 'c' ? 1-r-k : ink.id === 'm' ? 1-g-k : ink.id === 'y' ? 1-b-k : k;
                            val *= ink.limit;

                            let radius = (gridStep / 1.5) * Math.sqrt(Math.pow(val, config.dotContrast)) * config.dotScale;
                            if (config.forceMinDot) radius = Math.max(radius, (gridStep / 1.5) * 0.15 * config.dotScale);
                            else if (val <= 0.05) radius = 0;

                            if (radius > 0) {
                                ctx.beginPath();
                                /**
                                 * FIXED INK BLEED LOGIC: Added jitter resolution and visible scale
                                 */
                                if (config.inkBleed > 0) {
                                    const segments = 16;
                                    for (let s = 0; s <= segments; s++) {
                                        const a = (s / segments) * Math.PI * 2;
                                        // Use coordinate-based noise for consistent deformation
                                        const noise = Math.sin(gx * 0.1 + gy * 0.1 + s) * Math.cos(s * 2);
                                        const jitter = noise * config.inkBleed * gridStep * 0.4;
                                        const px = x + Math.cos(a) * (radius + jitter), py = y + Math.sin(a) * (radius + jitter);
                                        if (s === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
                                    }
                                } else ctx.arc(x, y, radius, 0, Math.PI * 2);
                                ctx.fill();
                            }
                        }
                    }
                }
            });
        }

        document.getElementById('download-btn').onclick = () => { const l = document.createElement('a'); l.download = 'export.png'; l.href = canvas.toDataURL('image/png'); l.click(); };

        // Initial launch
        window.onload = () => { render(); };
        window.onresize = () => { render(); };
    </script>
</body>
</html>
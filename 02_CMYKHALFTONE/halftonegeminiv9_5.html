<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Halftone Studio v5.1</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>

        body { font-family: 'Inter', sans-serif; background-color: #f1f1f2; -webkit-font-smoothing: antialiased; }

        input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; cursor: pointer; }

        .std-slider::-webkit-slider-runnable-track { height: 2px; background: #e5e7eb; border-radius: 2px; }

        .std-slider::-webkit-slider-thumb { height: 12px; width: 12px; border-radius: 50%; background: #111827; -webkit-appearance: none; margin-top: -5px; border: 2px solid #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        

        .collapsible-content { transition: max-height 0.3s ease-in-out; overflow: hidden; }

        .collapsed .collapsible-content { max-height: 0 !important; }

        .collapsed .toggle-arrow { transform: rotate(-90deg); }



        .color-card { @apply bg-white border border-slate-100 rounded-xl p-3 flex items-center gap-3 cursor-pointer hover:bg-slate-50 transition-all shadow-sm; }

        

        #preview-container { display: flex; flex-direction: column; overflow: hidden; background-color: #f4f4f5; width: 100%; height: 100%; position: relative; }

        

        #canvas-wrapper { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: grab; position: relative; }

        #canvas-wrapper:active { cursor: grabbing; }

        canvas { box-shadow: 0 40px 80px -15px rgb(0 0 0 / 0.4); background-color: #000; display: block; transform-origin: center; will-change: transform; }



        #floating-settings { position: fixed; z-index: 1000; display: none; background: white; border-radius: 16px; width: 280px; padding: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; box-sizing: border-box; }

        #floating-settings.active { display: block; }

        

        #m-hue { height: 14px; border-radius: 7px; background: linear-gradient(to right, #f00 0%, #ff0 17%, #0f0 33%, #0ff 50%, #00f 67%, #f0f 83%, #f00 100%); margin: 12px 0; }

        #m-hue::-webkit-slider-runnable-track { background: none; border: none; }

        #m-hue::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: white; border: 2px solid #cbd5e1; margin-top: -2px; }



        #sb-cursor { width: 12px; height: 12px; border: 2px solid white; border-radius: 50%; position: absolute; transform: translate(-50%, -50%); box-shadow: 0 1px 3px rgba(0,0,0,0.3); pointer-events: none; }

    </style>

</head>

<body class="flex h-screen w-screen overflow-hidden text-slate-900 font-medium text-[11px]">



    <div id="floating-settings" class="space-y-4">

        <div class="flex items-center justify-between">

            <span id="m-title" class="font-bold uppercase text-[10px] text-slate-500 italic italic">Channel</span>

             <div class="flex items-center gap-1 bg-slate-100 rounded-md px-1.5 py-0.5">

                <span class="text-[8px] font-bold text-slate-400">HEX</span>

                <input type="text" id="m-hex" class="bg-transparent text-[10px] font-mono outline-none w-12 text-center uppercase">

            </div>

        </div>

        <input type="range" id="m-hue" min="0" max="360" value="0">

        <div id="sb-picker" class="w-full h-32 rounded-lg relative cursor-crosshair border border-slate-100">

            <div id="sb-cursor" class="absolute"></div>

        </div>

        <div class="grid grid-cols-3 gap-2">

            <input type="number" id="m-h-input" class="bg-slate-50 border rounded p-1 text-center outline-none" placeholder="H">

            <input type="number" id="m-s-input" class="bg-slate-50 border rounded p-1 text-center outline-none" placeholder="S">

            <input type="number" id="m-b-input" class="bg-slate-50 border rounded p-1 text-center outline-none" placeholder="B">

        </div>

        <div class="space-y-3 pt-2 border-t border-slate-100">

            <div class="space-y-1">

                <div class="flex justify-between uppercase font-bold text-slate-400 text-[9px]"><span>Ink Strength</span><span id="m-str-val">1.00</span></div>

                <input type="range" id="m-str" min="0" max="1.0" step="0.05" class="std-slider">

            </div>

            <div class="space-y-1" id="opa-container">

                <div class="flex justify-between uppercase font-bold text-slate-400 text-[9px]"><span>Ink Opacity</span><span id="m-opa-val">1.00</span></div>

                <input type="range" id="m-opa" min="0" max="1.0" step="0.01" class="std-slider">

            </div>

        </div>

    </div>



    <aside class="w-80 flex-shrink-0 border-r border-slate-200 bg-white p-6 overflow-y-auto z-50 flex flex-col shadow-xl">

        <h1 class="text-[10px] font-black uppercase tracking-[0.4em] text-slate-400 mb-8 italic">Halftone Studio</h1>

        <label class="mb-8 group flex flex-col items-center justify-center w-full h-16 border-2 border-dashed border-slate-200 rounded-2xl cursor-pointer hover:border-slate-400 hover:bg-slate-50 transition-all">

            <span class="text-[10px] font-bold uppercase text-slate-500">Upload Image</span>

            <input id="img-upload" type="file" class="hidden" accept="image/*" />

        </label>



        <div class="space-y-4 flex-1">

            <section id="sec-base" class="collapsed border-b pb-2 border-slate-100">

                <button onclick="toggleSection('sec-base')" class="flex items-center justify-between w-full py-2 group">

                    <h2 class="text-[10px] font-black uppercase text-slate-400">Base Image</h2>

                    <svg class="toggle-arrow w-3 h-3 transition-transform text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path d="M19 9l-7 7-7-7"></path></svg>

                </button>

                <div class="collapsible-content space-y-4 pt-2">

                    <div class="space-y-1">

                        <div class="flex justify-between uppercase"><span>Blur</span><span id="blur-val">0</span></div>

                        <input type="range" id="blur" min="0" max="10" step="0.5" value="0" class="std-slider">

                    </div>

                    <div class="space-y-1">

                        <div class="flex justify-between uppercase"><span>Shadows</span><span id="shadows-val">0.00</span></div>

                        <input type="range" id="shadows" min="-0.5" max="0.5" step="0.01" value="0" class="std-slider">

                    </div>

                    <div class="space-y-1">

                        <div class="flex justify-between uppercase"><span>Highlights</span><span id="highlights-val">1.00</span></div>

                        <input type="range" id="highlights" min="0.5" max="1.5" step="0.01" value="1.0" class="std-slider">

                    </div>

                    <div class="space-y-1">

                        <div class="flex justify-between uppercase"><span>Contrast</span><span id="contrast-val">1.0</span></div>

                        <input type="range" id="contrast" min="0.5" max="2.0" step="0.1" value="1.0" class="std-slider">

                    </div>

                </div>

            </section>



            <section id="sec-palette" class="border-b pb-2 border-slate-100">

                <button onclick="toggleSection('sec-palette')" class="flex items-center justify-between w-full py-2 group">

                    <h2 class="text-[10px] font-black uppercase text-slate-400">Palette & Strength</h2>

                    <svg class="toggle-arrow w-3 h-3 transition-transform text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path d="M19 9l-7 7-7-7"></path></svg>

                </button>

                <div class="collapsible-content pt-4 space-y-2.5">

                    <div class="grid grid-cols-2 gap-2">

                        <div class="color-card" onclick="openAnchoredSettings(this, 'c')"><div id="sw-c" class="w-3.5 h-3.5 rounded bg-[#00ffff] border border-black/5"></div><span class="text-[9px] font-black uppercase">Cyan</span></div>

                        <div class="color-card" onclick="openAnchoredSettings(this, 'm')"><div id="sw-m" class="w-3.5 h-3.5 rounded bg-[#ff00ff] border border-black/5"></div><span class="text-[9px] font-black uppercase">Mag</span></div>

                        <div class="color-card" onclick="openAnchoredSettings(this, 'y')"><div id="sw-y" class="w-3.5 h-3.5 rounded bg-[#ffff00] border border-black/5"></div><span class="text-[9px] font-black uppercase">Yel</span></div>

                        <div class="color-card" onclick="openAnchoredSettings(this, 'k')"><div id="sw-k" class="w-3.5 h-3.5 rounded bg-[#000000] border border-black/5"></div><span class="text-[9px] font-black uppercase">Black</span></div>

                    </div>

                    <div class="color-card" onclick="openAnchoredSettings(this, 'paper')"><div id="sw-paper" class="w-3.5 h-3.5 rounded bg-[#fdfaf0] border border-slate-200"></div><span class="text-[9px] font-black uppercase tracking-tight">Paper Stock</span></div>

                </div>

            </section>



            <section id="sec-physics" class="pb-2">

                <button onclick="toggleSection('sec-physics')" class="flex items-center justify-between w-full py-2 group">

                    <h2 class="text-[10px] font-black uppercase text-slate-400">Halftone Physics</h2>

                    <svg class="toggle-arrow w-3 h-3 transition-transform text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path d="M19 9l-7 7-7-7"></path></svg>

                </button>

                <div class="collapsible-content space-y-4 pt-2">

                    <div class="flex items-center justify-between bg-slate-50 p-2.5 rounded-xl border border-slate-100">

                        <span class="font-bold uppercase text-slate-700">Fill Highlights</span>

                        <input id="forceMinDot" type="checkbox" class="w-7 h-4 bg-slate-200 checked:bg-slate-900 rounded-full appearance-none cursor-pointer transition-all relative after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-3 after:w-3 checked:after:translate-x-3"/>

                    </div>

                    <div class="space-y-1">

                        <div class="text-[11px] font-bold uppercase mb-1 text-slate-400">Ink Bleed (Irregularity)</div>

                        <select id="inkBleed" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-[11px] font-bold uppercase outline-none">

                            <option value="0">None</option><option value="0.1">Subtle</option><option value="0.2">Moderate</option><option value="0.3">Strong</option>

                        </select>

                    </div>

                    <div class="space-y-1">

                        <div class="flex justify-between uppercase"><span>Resolution</span><span id="frequency-val">85</span></div>

                        <input type="range" id="frequency" min="30" max="200" value="85" class="std-slider">

                    </div>

                    <div class="space-y-1">

                        <div class="flex justify-between uppercase"><span>Size Curve</span><span id="dotContrast-val">1.00</span></div>

                        <input type="range" id="dotContrast" min="0.5" max="3.0" step="0.1" value="1.0" class="std-slider">

                    </div>

                    <div class="space-y-1">

                        <div class="flex justify-between uppercase"><span>Global Scale</span><span id="dotScale-val">1.00</span></div>

                        <input type="range" id="dotScale" min="0.1" max="3.0" step="0.1" value="1.0" class="std-slider">

                    </div>

                </div>

            </section>

        </div>

        <button id="download-btn" class="mt-8 w-full bg-slate-950 text-white text-[10px] font-black uppercase py-4 rounded-2xl active:scale-[0.98]">Download Export</button>

    </aside>



    <main class="flex-1 relative" id="preview-container">

        <div id="canvas-wrapper">

            <canvas id="mainCanvas"></canvas>

            <p id="placeholder" class="absolute pointer-events-none text-white/50 font-black uppercase text-[10px]">Workspace Empty</p>

        </div>



        <div class="fixed bottom-8 right-8 flex items-center bg-white/95 backdrop-blur shadow-2xl rounded-full px-2 py-1.5 border border-slate-200 z-50">

            <button id="z-in" class="p-2 hover:bg-slate-100 rounded-full font-bold text-slate-900">+</button>

            <button id="z-out" class="p-2 hover:bg-slate-100 rounded-full font-bold text-slate-900">-</button>

            <div class="w-[1px] h-6 bg-slate-100 mx-2"></div>

            <select id="z-sel" class="bg-transparent text-[10px] font-black uppercase pl-2 pr-6 appearance-none cursor-pointer outline-none">

                <option value="0.5">50%</option><option value="0.75">75%</option>

                <option value="1" selected>FIT</option><option value="2">200%</option><option value="4">400%</option>

            </select>

            <div class="w-[1px] h-6 bg-slate-100 mx-2"></div>

            <button id="z-fit" class="px-2 py-1 hover:bg-slate-100 rounded-full text-[10px] font-black">FIT</button>

        </div>

    </main>



    <script>

        const canvas = document.getElementById('mainCanvas'), ctx = canvas.getContext('2d', { alpha: false });

        const wrapper = document.getElementById('canvas-wrapper'), zoomSelect = document.getElementById('z-sel'), popup = document.getElementById('floating-settings');

        

        let sourceBitmap = null, currentZoom = 1.0, panX = 0, panY = 0;

        let isPanning = false, lastX, lastY, activeChannel = 'c';



        const config = { 

            blur: 0, shadows: 0, highlights: 1.0, contrast: 1.0, dotContrast: 1.0, frequency: 85, dotScale: 1.0, inkBleed: 0, forceMinDot: false,

            paper: { id: 'paper', hex: "#fdfaf0", h: 50, s: 6, b: 99 },

            channels: {

                c: { id: 'c', hex: "#00ffff", h: 180, s: 100, b: 100, limit: 1.0, opacity: 0.95, ang: 15 },

                m: { id: 'm', hex: "#ff00ff", h: 300, s: 100, b: 100, limit: 1.0, opacity: 0.95, ang: 75 },

                y: { id: 'y', hex: "#ffff00", h: 60, s: 100, b: 100, limit: 1.0, opacity: 0.95, ang: 0 },

                k: { id: 'k', hex: "#000000", h: 0, s: 0, b: 0, limit: 0.5, opacity: 0.95, ang: 45 }

            }

        };



        // --- STABILITY UTILS ---

        function seededRandom(seed) {

            const x = Math.sin(seed) * 10000;

            return x - Math.floor(x);

        }



        function getFitScale() {

            if (!sourceBitmap) return 1.0;

            const pad = 80;

            return Math.min((wrapper.clientWidth - pad) / sourceBitmap.width, (wrapper.clientHeight - pad) / sourceBitmap.height);

        }



        function updateTransform() {

            canvas.style.transform = `translate(${panX}px, ${panY}px) scale(${currentZoom})`;

            const fit = getFitScale();

            const pct = Math.round((currentZoom / fit) * 100);

            let found = Array.from(zoomSelect.options).find(o => Math.abs(parseFloat(o.value) - (currentZoom/fit)) < 0.01);

            if(found) zoomSelect.value = found.value;

            else {

                let custom = document.getElementById('z-custom') || document.createElement('option');

                custom.id = 'z-custom'; custom.value = currentZoom/fit; custom.textContent = `${pct}%`;

                if(!custom.parentElement) zoomSelect.appendChild(custom);

                zoomSelect.value = custom.value;

            }

        }



        // --- DRAWING LOGIC (RESTORED FROM SNIPPET) ---

        function render() {

            const dw = sourceBitmap ? sourceBitmap.width : 800;

            const dh = sourceBitmap ? sourceBitmap.height : 600;

            canvas.width = dw; canvas.height = dh;

            ctx.fillStyle = config.paper.hex; ctx.fillRect(0, 0, dw, dh);

            if (!sourceBitmap) { updateTransform(); return; }



            const bCtx = document.createElement('canvas').getContext('2d');

            bCtx.canvas.width = dw; bCtx.canvas.height = dh;

            if (config.blur > 0) bCtx.filter = `blur(${config.blur}px)`;

            bCtx.drawImage(sourceBitmap, 0, 0, dw, dh);

            const imgData = bCtx.getImageData(0, 0, dw, dh).data;



            ctx.globalCompositeOperation = 'multiply';

            const gridStep = dw / config.frequency;

            const diag = Math.sqrt(dw**2 + dh**2);



            Object.values(config.channels).forEach(ink => {

                ctx.globalAlpha = ink.opacity; ctx.fillStyle = ink.hex;

                const rad = ink.ang * (Math.PI / 180), cosA = Math.cos(rad), sinA = Math.sin(rad);



                for (let gx = -diag; gx < diag; gx += gridStep) {

                    for (let gy = -diag; gy < diag; gy += gridStep) {

                        const x = gx * cosA - gy * sinA + dw/2, y = gx * sinA + gy * cosA + dh/2;

                        if (x >= 0 && x < dw && y >= 0 && y < dh) {

                            const i = (Math.floor(y) * dw + Math.floor(x)) * 4;

                            const apply = v => Math.pow(Math.max(0, Math.min(1, (v/255 - config.shadows) / (config.highlights - config.shadows))), config.contrast);

                            const r = apply(imgData[i]), g = apply(imgData[i+1]), b = apply(imgData[i+2]);

                            const k = 1 - Math.max(r, g, b);

                            

                            let val = ink.id === 'c' ? 1-r-k : ink.id === 'm' ? 1-g-k : ink.id === 'y' ? 1-b-k : k;

                            

                            // Reinstating Snippet Limit & Radius Math

                            val = val * ink.limit;

                            const density = Math.pow(val, config.dotContrast);

                            let radius = (gridStep / 1.5) * Math.sqrt(density) * config.dotScale;



                            if (config.forceMinDot) radius = Math.max(radius, (gridStep / 1.5) * 0.15 * config.dotScale);

                            else if (val <= 0.05) radius = 0;



                            if (radius > 0) {

                                if (config.inkBleed > 0) {

                                    const segments = 10;

                                    ctx.beginPath();

                                    for (let s = 0; s <= segments; s++) {

                                        const angle = (s / segments) * Math.PI * 2;

                                        // Reinstated seededRandom jitter

                                        const jitter = (seededRandom(gx + gy + s + ink.ang) - 0.5) * config.inkBleed * 5;

                                        const rJitter = radius + jitter;

                                        const sx = x + Math.cos(angle) * rJitter;

                                        const sy = y + Math.sin(angle) * rJitter;

                                        if (s === 0) ctx.moveTo(sx, sy);

                                        else ctx.lineTo(sx, sy);

                                    }

                                    ctx.closePath();

                                    ctx.fill();

                                } else {

                                    ctx.beginPath();

                                    ctx.arc(x, y, radius, 0, Math.PI * 2);

                                    ctx.fill();

                                }

                            }

                        }

                    }

                }

            });

            ctx.globalAlpha = 1.0;

            updateTransform();

        }



        // --- CORE UI & INTERACTION ---

        wrapper.onmousedown = (e) => { if(e.target === canvas || e.target === wrapper) { isPanning = true; lastX = e.clientX; lastY = e.clientY; } };

        window.onmousemove = (e) => { if(!isPanning) return; panX += (e.clientX - lastX); panY += (e.clientY - lastY); lastX = e.clientX; lastY = e.clientY; updateTransform(); };

        window.onmouseup = () => isPanning = false;



        document.addEventListener('mousedown', (e) => { if (popup.classList.contains('active') && !popup.contains(e.target) && !e.target.closest('.color-card')) popup.classList.remove('active'); });



        function hsbToHex(h, s, b) { b /= 100; s /= 100; const k = n => (n + h / 60) % 6, f = n => b * (1 - s * Math.max(0, Math.min(k(n), 4 - k(n), 1))); return "#" + [f(5), f(3), f(1)].map(x => Math.round(x * 255).toString(16).padStart(2, '0')).join(''); }

        

        function openAnchoredSettings(el, chan) {

            activeChannel = chan;

            const data = chan === 'paper' ? config.paper : config.channels[chan];

            const rect = el.getBoundingClientRect();

            popup.style.top = `${Math.max(20, Math.min(window.innerHeight - 340, rect.top))}px`;

            popup.style.left = `${rect.right + 15}px`;

            document.getElementById('m-title').textContent = chan === 'paper' ? 'Paper Stock' : chan.toUpperCase();

            document.getElementById('opa-container').style.display = chan === 'paper' ? 'none' : 'block';

            if(chan !== 'paper') { document.getElementById('m-str').value = data.limit; document.getElementById('m-opa').value = data.opacity; document.getElementById('m-str-val').textContent = data.limit.toFixed(2); document.getElementById('m-opa-val').textContent = data.opacity.toFixed(2); }

            popup.classList.add('active'); updatePickerUI(data.h, data.s, data.b);

        }



        function updatePickerUI(h, s, b) {

            const hex = hsbToHex(h, s, b);

            const data = activeChannel === 'paper' ? config.paper : config.channels[activeChannel];

            data.h = h; data.s = s; data.b = b; data.hex = hex;

            document.getElementById('sb-picker').style.background = `linear-gradient(to top, #000, transparent), linear-gradient(to right, #fff, hsl(${h}, 100%, 50%))`;

            document.getElementById('sb-cursor').style.left = `${s}%`; document.getElementById('sb-cursor').style.top = `${100-b}%`;

            document.getElementById('m-hue').value = h; document.getElementById('m-hex').value = hex.substring(1).toUpperCase();

            document.getElementById('m-h-input').value = Math.round(h); document.getElementById('m-s-input').value = Math.round(s); document.getElementById('m-b-input').value = Math.round(b);

            document.getElementById(`sw-${activeChannel}`).style.backgroundColor = hex;

            render();

        }



        document.getElementById('img-upload').onchange = async (e) => { const file = e.target.files[0]; if(!file) return; sourceBitmap = await createImageBitmap(file); document.getElementById('placeholder').style.display = 'none'; currentZoom = getFitScale(); panX = 0; panY = 0; render(); };

        

        document.getElementById('sb-picker').onmousedown = (e) => {

            const move = (ev) => { const r = document.getElementById('sb-picker').getBoundingClientRect(); const s = Math.max(0, Math.min(100, ((ev.clientX - r.left) / r.width) * 100)); const b = Math.max(0, Math.min(100, 100 - ((ev.clientY - r.top) / r.height) * 100)); updatePickerUI(parseFloat(document.getElementById('m-hue').value), s, b); };

            move(e); window.onmousemove = move; window.onmouseup = () => window.onmousemove = null;

        };



        ['blur', 'shadows', 'highlights', 'contrast', 'dotContrast', 'frequency', 'dotScale'].forEach(k => { document.getElementById(k).oninput = (e) => { config[k] = parseFloat(e.target.value); document.getElementById(`${k}-val`).textContent = config[k].toFixed(2); render(); }; });

        document.getElementById('m-hue').oninput = (e) => { const data = activeChannel === 'paper' ? config.paper : config.channels[activeChannel]; updatePickerUI(parseFloat(e.target.value), data.s, data.b); };

        document.getElementById('m-str').oninput = (e) => { config.channels[activeChannel].limit = parseFloat(e.target.value); document.getElementById('m-str-val').textContent = parseFloat(e.target.value).toFixed(2); render(); };

        document.getElementById('m-opa').oninput = (e) => { config.channels[activeChannel].opacity = parseFloat(e.target.value); document.getElementById('m-opa-val').textContent = parseFloat(e.target.value).toFixed(2); render(); };

        

        zoomSelect.onchange = (e) => { currentZoom = getFitScale() * parseFloat(e.target.value); updateTransform(); };

        document.getElementById('z-fit').onclick = () => { currentZoom = getFitScale(); panX = 0; panY = 0; updateTransform(); };

        document.getElementById('z-in').onclick = () => { currentZoom *= 1.2; updateTransform(); };

        document.getElementById('z-out').onclick = () => { currentZoom *= 0.8; updateTransform(); };

        document.getElementById('inkBleed').onchange = (e) => { config.inkBleed = parseFloat(e.target.value); render(); };

        document.getElementById('forceMinDot').onchange = (e) => { config.forceMinDot = e.target.checked; render(); };

        document.getElementById('download-btn').onclick = () => { const l = document.createElement('a'); l.download = 'halftone.png'; l.href = canvas.toDataURL(); l.click(); };

        

        function toggleSection(id) { document.getElementById(id).classList.toggle('collapsed'); }

        window.onload = () => { render(); currentZoom = getFitScale(); updateTransform(); };

    </script>

</body>

</html>
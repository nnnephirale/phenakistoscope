<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halftone Engine v1.7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f1f2; -webkit-font-smoothing: antialiased; }
        input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; }
        input[type=range]::-webkit-slider-runnable-track { height: 4px; background: #e5e7eb; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { height: 16px; width: 16px; border-radius: 50%; background: #111827; -webkit-appearance: none; margin-top: -6px; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; }
        canvas { max-width: 100%; max-height: 100%; object-fit: contain; }
    </style>
</head>
<body class="flex h-screen w-screen overflow-hidden text-slate-900">

    <aside class="w-80 flex-shrink-0 border-r border-slate-200 bg-white p-8 overflow-y-auto flex flex-col">
        <h1 class="text-[10px] font-bold tracking-[0.3em] uppercase text-slate-400 mb-10">Halftone Engine</h1>

        <label class="mb-8 group flex flex-col items-center justify-center w-full h-20 border-2 border-dashed border-slate-200 rounded-2xl cursor-pointer hover:border-slate-400 hover:bg-slate-50 transition-all">
            <span class="text-[11px] font-bold uppercase text-slate-500">Upload Image</span>
            <input id="img-upload" type="file" class="hidden" accept="image/*" />
        </label>

        <div class="space-y-8 flex-1">
            <div class="space-y-6">
                <h2 class="text-[10px] font-black uppercase tracking-widest text-slate-400 border-b pb-2">Pre-Process</h2>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Blur</span><span id="blur-val" class="text-slate-400">1.5</span></div>
                    <input type="range" id="blur" min="0" max="10" step="0.5" value="1.5">
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Threshold</span><span id="threshold-val" class="text-slate-400">0.08</span></div>
                    <input type="range" id="threshold" min="0" max="0.5" step="0.01" value="0.08">
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Contrast</span><span id="contrast-val" class="text-slate-400">1.0</span></div>
                    <input type="range" id="contrast" min="0.5" max="2.0" step="0.1" value="1.0">
                </div>
            </div>

            <div class="space-y-6">
                <h2 class="text-[10px] font-black uppercase tracking-widest text-slate-400 border-b pb-2">Halftone</h2>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Resolution</span><span id="frequency-val" class="text-slate-400">85</span></div>
                    <input type="range" id="frequency" min="30" max="200" value="85">
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Ink Density</span><span id="dotScale-val" class="text-slate-400">1.0</span></div>
                    <input type="range" id="dotScale" min="0.5" max="2.5" step="0.1" value="1.0">
                </div>
            </div>
        </div>

        <button id="download-btn" class="mt-8 w-full bg-slate-950 text-white text-[11px] font-bold tracking-widest uppercase py-4 rounded-xl hover:bg-black transition-transform active:scale-95">Download PNG</button>
    </aside>

    <main class="flex-1 bg-zinc-100 flex items-center justify-center p-12 overflow-hidden">
        <div class="relative max-w-full max-h-full flex items-center justify-center bg-[#fdfaf0] shadow-2xl rounded-sm p-1">
            <canvas id="mainCanvas"></canvas>
            <p id="placeholder" class="absolute text-slate-300 font-bold uppercase tracking-widest text-[10px]">Studio Empty</p>
        </div>
    </main>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        let sourceBitmap = null;
        const config = { blur: 1.5, threshold: 0.08, contrast: 1.0, frequency: 85, dotScale: 1.0 };

        // Handle Image Upload with Native Orientation Fix
        document.getElementById('img-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            // createImageBitmap naturally respects EXIF orientation in modern browsers
            sourceBitmap = await createImageBitmap(file);
            document.getElementById('placeholder').style.display = 'none';
            render();
        });

        // Combined UI Listener
        ['blur', 'threshold', 'contrast', 'frequency', 'dotScale'].forEach(key => {
            document.getElementById(key).addEventListener('input', (e) => {
                config[key] = parseFloat(e.target.value);
                document.getElementById(`${key}-val`).textContent = config[key];
                if (sourceBitmap) requestAnimationFrame(render);
            });
        });

        function render() {
            if (!sourceBitmap) return;
            const { width: w, height: h } = sourceBitmap;
            canvas.width = w; canvas.height = h;

            // 1. Pre-process into offscreen buffer
            const buffer = document.createElement('canvas');
            buffer.width = w; buffer.height = h;
            const bCtx = buffer.getContext('2d');
            bCtx.filter = `blur(${config.blur}px)`;
            bCtx.drawImage(sourceBitmap, 0, 0);
            const imgData = bCtx.getImageData(0, 0, w, h).data;

            // 2. Clear visible canvas (Cream background)
            ctx.fillStyle = "#fdfaf0"; 
            ctx.fillRect(0, 0, w, h);
            ctx.globalCompositeOperation = 'multiply';

            const colors = [
                { name: 'c', color: '#00FFFF', angle: 15 },
                { name: 'm', color: '#FF00FF', angle: 75 },
                { name: 'y', color: '#FFFF00', angle: 0 },
                { name: 'k', color: '#000000', angle: 45 }
            ];

            const gridStep = w / config.frequency;
            const diag = Math.sqrt(w*w + h*h);

            colors.forEach(ink => {
                ctx.fillStyle = ink.color;
                const rad = ink.angle * (Math.PI / 180);
                const cosA = Math.cos(rad), sinA = Math.sin(rad);

                for (let x = -diag/2; x < diag; x += gridStep) {
                    for (let y = -diag/2; y < diag; y += gridStep) {
                        // Coordinate mapping
                        const rotX = x * cosA - y * sinA + w/2;
                        const rotY = x * sinA + y * cosA + h/2;

                        if (rotX >= 0 && rotX < w && rotY >= 0 && rotY < h) {
                            const i = (Math.floor(rotY) * w + Math.floor(rotX)) * 4;
                            const r = imgData[i]/255, g = imgData[i+1]/255, b = imgData[i+2]/255;
                            
                            // Threshold/Contrast
                            if ((r + g + b) / 3 > (1 - config.threshold)) continue;
                            const rc = Math.pow(r, config.contrast), gc = Math.pow(g, config.contrast), bc = Math.pow(b, config.contrast);

                            // CMYK logic
                            const k = 1 - Math.max(rc, gc, bc);
                            let val = 0;
                            if (ink.name === 'c') val = (1-rc-k)/(1-k) || 0;
                            else if (ink.name === 'm') val = (1-gc-k)/(1-k) || 0;
                            else if (ink.name === 'y') val = (1-bc-k)/(1-k) || 0;
                            else val = k;

                            if (val > 0.01) {
                                const radius = (gridStep / 2) * val * config.dotScale;
                                const drawX = x * Math.cos(-rad) - y * Math.sin(-rad) + w/2;
                                const drawY = x * Math.sin(-rad) + y * Math.cos(-rad) + h/2;
                                ctx.beginPath();
                                ctx.arc(drawX, drawY, radius, 0, 6.28);
                                ctx.fill();
                            }
                        }
                    }
                }
            });
        }

        document.getElementById('download-btn').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'halftone-export.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    </script>
</body>
</html>
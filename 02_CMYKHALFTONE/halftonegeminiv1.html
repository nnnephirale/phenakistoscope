<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMYK Halftone Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; -webkit-font-smoothing: antialiased; }
        input[type=range] { -webkit-appearance: none; background: transparent; transition: opacity 0.2s; }
        input[type=range]:hover { opacity: 0.8; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e2e8f0; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { height: 16px; width: 16px; border-radius: 50%; background: #0f172a; cursor: pointer; -webkit-appearance: none; margin-top: -6px; border: 2px solid #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.15); }
        .canvas-card { transition: transform 0.3s ease; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1); }
        #mainCanvas { background: white; cursor: crosshair; }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-slate-900">

    <aside class="w-80 border-r border-slate-200 bg-white p-8 overflow-y-auto z-10 flex flex-col">
        <div class="mb-10">
            <h1 class="text-[10px] font-bold tracking-[0.3em] uppercase text-slate-400">Halftone Engine v1.0</h1>
        </div>

        <div class="mb-8">
            <label id="drop-zone" class="group flex flex-col items-center justify-center w-full h-24 border-2 border-dashed border-slate-200 rounded-2xl cursor-pointer hover:border-slate-400 hover:bg-slate-50 transition-all">
                <div class="flex flex-col items-center justify-center">
                    <p class="text-xs font-medium text-slate-500 group-hover:text-slate-700">Drop image or click</p>
                </div>
                <input id="img-upload" type="file" class="hidden" accept="image/*" />
            </label>
        </div>

        <div class="space-y-8 flex-1">
            <div class="space-y-6">
                <h2 class="text-[11px] font-bold uppercase tracking-wider text-slate-400 border-b border-slate-100 pb-2">Printing Parameters</h2>
                
                <div class="space-y-3">
                    <div class="flex justify-between text-xs font-semibold uppercase tracking-tighter">
                        <span>Resolution</span>
                        <span id="frequency-val" class="text-slate-400 tabular-nums">40</span>
                    </div>
                    <input type="range" id="frequency" min="20" max="200" value="40" class="w-full">
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between text-xs font-semibold uppercase tracking-tighter">
                        <span>Ink Density</span>
                        <span id="dotScale-val" class="text-slate-400 tabular-nums">1.2</span>
                    </div>
                    <input type="range" id="dotScale" min="0.5" max="3.0" step="0.1" value="1.2" class="w-full">
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between text-xs font-semibold uppercase tracking-tighter">
                        <span>Contrast</span>
                        <span id="contrast-val" class="text-slate-400 tabular-nums">1.0</span>
                    </div>
                    <input type="range" id="contrast" min="0.5" max="2.5" step="0.1" value="1.0" class="w-full">
                </div>
            </div>
        </div>

        <button id="download-btn" class="mt-8 w-full bg-slate-900 text-white text-[13px] font-semibold py-3 rounded-xl hover:bg-black transition-all active:scale-[0.97] shadow-lg shadow-slate-200">
            Export Master
        </button>
    </aside>

    <main class="flex-1 bg-[#fcfcfd] flex items-center justify-center p-12 relative">
        <div id="loading-hint" class="absolute inset-0 flex items-center justify-center bg-white/50 backdrop-blur-sm z-20 hidden">
            <span class="text-xs font-bold uppercase tracking-widest text-slate-400 animate-pulse">Processing...</span>
        </div>

        <div class="canvas-card bg-white p-1 rounded-sm border border-slate-200 overflow-hidden">
            <canvas id="mainCanvas"></canvas>
        </div>
        
        <p id="placeholder-text" class="absolute text-slate-300 font-medium tracking-tight">Image Studio Empty</p>
    </main>

    <script>
        const upload = document.getElementById('img-upload');
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { alpha: false }); // Optimization: no alpha channel needed
        const loadingHint = document.getElementById('loading-hint');
        
        let originalImg = null;
        let isRendering = false;
        let renderRequested = false;

        const config = {
            frequency: 40,
            dotScale: 1.2,
            contrast: 1.0
        };

        // UI Event Handling
        upload.addEventListener('change', handleImage);
        
        function handleImage(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                originalImg = new Image();
                originalImg.onload = () => {
                    document.getElementById('placeholder-text').style.display = 'none';
                    requestRender();
                };
                originalImg.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Optimized Input Loop
        ['frequency', 'dotScale', 'contrast'].forEach(key => {
            const input = document.getElementById(key);
            const display = document.getElementById(`${key}-val`);
            input.addEventListener('input', (e) => {
                config[key] = parseFloat(e.target.value);
                display.innerText = e.target.value;
                requestRender();
            });
        });

        // RequestAnimationFrame prevents the UI from choking
        function requestRender() {
            if (isRendering) {
                renderRequested = true;
                return;
            }
            requestAnimationFrame(render);
        }

        function render() {
            if (!originalImg) return;
            isRendering = true;

            // Step 1: Limit Canvas Size for Preview Performance
            const maxPreviewSize = 1000;
            let width = originalImg.width;
            let height = originalImg.height;
            
            if (width > maxPreviewSize) {
                const ratio = maxPreviewSize / width;
                width = maxPreviewSize;
                height = height * ratio;
            }

            canvas.width = width;
            canvas.height = height;

            // Step 2: Offscreen Buffer for sampling
            const buffer = document.createElement('canvas');
            buffer.width = width;
            buffer.height = height;
            const bCtx = buffer.getContext('2d');
            bCtx.drawImage(originalImg, 0, 0, width, height);
            const imgData = bCtx.getImageData(0, 0, width, height).data;

            // Step 3: Draw Background
            ctx.fillStyle = "#fff";
            ctx.fillRect(0, 0, width, height);

            const step = Math.max(2, Math.floor(width / config.frequency));
            const colors = [
                { name: 'cyan', color: 'rgba(0, 255, 255, 1)', angle: 15 },
                { name: 'magenta', color: 'rgba(255, 0, 255, 1)', angle: 75 },
                { name: 'yellow', color: 'rgba(255, 255, 0, 1)', angle: 0 },
                { name: 'black', color: 'rgba(0, 0, 0, 1)', angle: 45 }
            ];

            ctx.globalCompositeOperation = 'multiply';

            // Main Halftone Loop
            colors.forEach(ink => {
                ctx.fillStyle = ink.color;
                
                for (let y = 0; y < height; y += step) {
                    for (let x = 0; x < width; x += step) {
                        const i = (Math.floor(y) * width + Math.floor(x)) * 4;
                        
                        // RGB to CMYK
                        let r = imgData[i] / 255;
                        let g = imgData[i+1] / 255;
                        let b = imgData[i+2] / 255;

                        // Apple-style contrast curve
                        const c = config.contrast;
                        r = Math.pow(r, c);
                        g = Math.pow(g, c);
                        b = Math.pow(b, c);

                        const k = 1 - Math.max(r, g, b);
                        let val = 0;
                        
                        if (ink.name === 'cyan') val = (1 - r - k) / (1 - k) || 0;
                        else if (ink.name === 'magenta') val = (1 - g - k) / (1 - k) || 0;
                        else if (ink.name === 'yellow') val = (1 - b - k) / (1 - k) || 0;
                        else val = k;

                        if (val > 0.02) {
                            const radius = (step / 1.5) * val * config.dotScale;
                            // Drawing rectangles is significantly faster than circles for preview
                            // but circles look better. We use arc but keep it simple.
                            ctx.beginPath();
                            ctx.arc(x, y, radius, 0, 6.28); 
                            ctx.fill();
                        }
                    }
                }
            });

            isRendering = false;
            if (renderRequested) {
                renderRequested = false;
                requestRender();
            }
        }

        document.getElementById('download-btn').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'cmyk-halftone.png';
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
        });
    </script>
</body>
</html>
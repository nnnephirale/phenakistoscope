<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halftone Engine v2.0 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f1f2; -webkit-font-smoothing: antialiased; }
        input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; }
        input[type=range]::-webkit-slider-runnable-track { height: 4px; background: #e5e7eb; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { height: 16px; width: 16px; border-radius: 50%; background: #111827; -webkit-appearance: none; margin-top: -6px; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; }
        canvas { max-width: 100%; max-height: 100%; object-fit: contain; }
    </style>
</head>
<body class="flex h-screen w-screen overflow-hidden text-slate-900">

    <aside class="w-80 flex-shrink-0 border-r border-slate-200 bg-white p-8 overflow-y-auto flex flex-col">
        <h1 class="text-[10px] font-bold tracking-[0.3em] uppercase text-slate-400 mb-10">Halftone Engine Pro</h1>

        <label class="mb-8 group flex flex-col items-center justify-center w-full h-20 border-2 border-dashed border-slate-200 rounded-2xl cursor-pointer hover:border-slate-400 hover:bg-slate-50 transition-all">
            <span class="text-[11px] font-bold uppercase text-slate-500">Upload Image</span>
            <input id="img-upload" type="file" class="hidden" accept="image/*" />
        </label>

        <div class="space-y-8 flex-1">
            <div class="space-y-6">
                <h2 class="text-[10px] font-black uppercase tracking-widest text-slate-400 border-b pb-2">Base Tone</h2>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Shadow Lift</span><span id="shadows-val" class="text-slate-400">0</span></div>
                    <input type="range" id="shadows" min="0" max="0.5" step="0.01" value="0">
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Highlight Comp</span><span id="highlights-val" class="text-slate-400">1.0</span></div>
                    <input type="range" id="highlights" min="0.5" max="1.0" step="0.01" value="1.0">
                </div>
            </div>

            <div class="space-y-6">
                <h2 class="text-[10px] font-black uppercase tracking-widest text-slate-400 border-b pb-2">Color Processing</h2>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Black Generation (K)</span><span id="kLimit-val" class="text-slate-400">0.5</span></div>
                    <input type="range" id="kLimit" min="0" max="1.0" step="0.05" value="0.5">
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Contrast</span><span id="contrast-val" class="text-slate-400">1.0</span></div>
                    <input type="range" id="contrast" min="0.5" max="2.0" step="0.1" value="1.0">
                </div>
            </div>

            <div class="space-y-6">
                <h2 class="text-[10px] font-black uppercase tracking-widest text-slate-400 border-b pb-2">Halftone</h2>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Resolution</span><span id="frequency-val" class="text-slate-400">85</span></div>
                    <input type="range" id="frequency" min="30" max="200" value="85">
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Dot Size</span><span id="dotScale-val" class="text-slate-400">1.0</span></div>
                    <input type="range" id="dotScale" min="0.1" max="3.0" step="0.1" value="1.0">
                </div>
            </div>
        </div>

        <button id="download-btn" class="mt-8 w-full bg-slate-950 text-white text-[11px] font-bold tracking-widest uppercase py-4 rounded-xl hover:bg-black transition-transform active:scale-95">Download PNG</button>
    </aside>

    <main class="flex-1 bg-zinc-100 flex items-center justify-center p-12 overflow-hidden">
        <div class="relative max-w-full max-h-full flex items-center justify-center bg-[#fdfaf0] shadow-2xl rounded-sm p-1">
            <canvas id="mainCanvas"></canvas>
            <p id="placeholder" class="absolute text-slate-300 font-bold uppercase tracking-widest text-[10px]">Studio Empty</p>
        </div>
    </main>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        let sourceBitmap = null;
        
        const config = { 
            shadows: 0, 
            highlights: 1.0, 
            kLimit: 0.5, 
            contrast: 1.0, 
            frequency: 85, 
            dotScale: 1.0, 
            threshold: 0.08 
        };

        document.getElementById('img-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            sourceBitmap = await createImageBitmap(file);
            document.getElementById('placeholder').style.display = 'none';
            render();
        });

        ['shadows', 'highlights', 'kLimit', 'contrast', 'frequency', 'dotScale'].forEach(key => {
            const el = document.getElementById(key);
            if (el) {
                el.addEventListener('input', (e) => {
                    config[key] = parseFloat(e.target.value);
                    document.getElementById(`${key}-val`).textContent = config[key];
                    if (sourceBitmap) requestAnimationFrame(render);
                });
            }
        });

        window.addEventListener('resize', () => { if (sourceBitmap) render(); });

        function render() {
            if (!sourceBitmap) return;

            const padding = 100;
            const maxWidth = window.innerWidth - 320 - padding;
            const maxHeight = window.innerHeight - padding;
            const aspect = sourceBitmap.width / sourceBitmap.height;
            let displayW = maxWidth;
            let displayH = maxWidth / aspect;
            if (displayH > maxHeight) { displayH = maxHeight; displayW = maxHeight * aspect; }
            canvas.width = displayW; canvas.height = displayH;

            const buffer = document.createElement('canvas');
            buffer.width = displayW; buffer.height = displayH;
            const bCtx = buffer.getContext('2d');
            bCtx.drawImage(sourceBitmap, 0, 0, displayW, displayH);
            const imgData = bCtx.getImageData(0, 0, displayW, displayH).data;

            ctx.fillStyle = "#fdfaf0"; 
            ctx.fillRect(0, 0, displayW, displayH);
            ctx.globalCompositeOperation = 'multiply';

            const colors = [
                { name: 'c', color: '#00FFFF', angle: 15 },
                { name: 'm', color: '#FF00FF', angle: 75 },
                { name: 'y', color: '#FFFF00', angle: 0 },
                { name: 'k', color: '#000000', angle: 45 }
            ];

            const gridStep = displayW / config.frequency;
            const diag = Math.sqrt(displayW**2 + displayH**2);
            const gamma = 1.2;

            colors.forEach(ink => {
                ctx.fillStyle = ink.color;
                const rad = ink.angle * (Math.PI / 180);
                const cosA = Math.cos(rad);
                const sinA = Math.sin(rad);

                for (let gx = -diag; gx < diag; gx += gridStep) {
                    for (let gy = -diag; gy < diag; gy += gridStep) {
                        const centerX = displayW / 2;
                        const centerY = displayH / 2;
                        const x = gx * cosA - gy * sinA + centerX;
                        const y = gx * sinA + gy * cosA + centerY;

                        if (x >= 0 && x < displayW && y >= 0 && y < displayH) {
                            const i = (Math.floor(y) * Math.floor(displayW) + Math.floor(x)) * 4;
                            
                            const remap = (val) => {
                                let v = val / 255;
                                v = (v * (config.highlights - config.shadows)) + config.shadows;
                                return Math.pow(v, gamma);
                            };

                            let r = Math.pow(remap(imgData[i]), config.contrast);
                            let g = Math.pow(remap(imgData[i+1]), config.contrast);
                            let b = Math.pow(remap(imgData[i+2]), config.contrast);

                            // REFINED CMYK WITH BLACK GENERATION CONTROL
                            // We calculate raw K, then apply the limit
                            const rawK = 1 - Math.max(r, g, b);
                            const k = rawK * config.kLimit; 

                            let val = 0;
                            // Using the modified K to calculate CMY forces CMY to pick up the slack
                            if (ink.name === 'c') val = (1 - r - k);
                            else if (ink.name === 'm') val = (1 - g - k);
                            else if (ink.name === 'y') val = (1 - b - k);
                            else val = k;

                            let density = Math.max(0, val);
                            
                            if (density > 0) {
                                // Dot growth calibrated for overlapping CMY "Rich Black"
                                const radius = (gridStep / 1.5) * Math.sqrt(density) * config.dotScale;
                                ctx.beginPath();
                                ctx.arc(x, y, Math.max(0.1, radius), 0, Math.PI * 2);
                                ctx.fill();
                            }
                        }
                    }
                }
            });
        }

        document.getElementById('download-btn').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'halftone-cmy-fronted.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
    </script>
</body>
</html>
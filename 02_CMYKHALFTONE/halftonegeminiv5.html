<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halftone Engine v2.6 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f1f2; -webkit-font-smoothing: antialiased; }
        input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; }
        input[type=range]::-webkit-slider-runnable-track { height: 4px; background: #e5e7eb; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { height: 16px; width: 16px; border-radius: 50%; background: #111827; -webkit-appearance: none; margin-top: -6px; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; }
        
        /* Centering Engine */
        #preview-container { 
            display: grid;
            place-items: center; /* Perfect vertical/horizontal centering */
            overflow: auto;
            cursor: grab; 
            user-select: none; 
            background-color: #f4f4f5;
        }
        #preview-container:active { cursor: grabbing; }
        #preview-container::-webkit-scrollbar { width: 8px; height: 8px; }
        #preview-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        #canvas-wrapper {
            padding: 80px; /* Breathing room for pan/scroll */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas { 
            box-shadow: 0 30px 60px -12px rgb(0 0 0 / 0.35); 
            pointer-events: none; 
            display: block;
        }
    </style>
</head>
<body class="flex h-screen w-screen overflow-hidden text-slate-900">

    <aside class="w-80 flex-shrink-0 border-r border-slate-200 bg-white p-8 overflow-y-auto z-20 flex flex-col shadow-2xl">
        <h1 class="text-[10px] font-bold tracking-[0.3em] uppercase text-slate-400 mb-10">Halftone Engine Pro</h1>

        <label class="mb-8 group flex flex-col items-center justify-center w-full h-20 border-2 border-dashed border-slate-200 rounded-2xl cursor-pointer hover:border-slate-400 hover:bg-slate-50 transition-all">
            <span class="text-[11px] font-bold uppercase text-slate-500">Upload Image</span>
            <input id="img-upload" type="file" class="hidden" accept="image/*" />
        </label>

        <div class="space-y-8 flex-1">
            <div class="space-y-6">
                <h2 class="text-[10px] font-black uppercase tracking-widest text-slate-400 border-b pb-2">Base Tone</h2>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Shadow Lift</span><span id="shadows-val" class="text-slate-400">0</span></div>
                    <input type="range" id="shadows" min="0" max="0.5" step="0.01" value="0">
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Highlight Comp</span><span id="highlights-val" class="text-slate-400">1.0</span></div>
                    <input type="range" id="highlights" min="0.5" max="1.0" step="0.01" value="1.0">
                </div>
            </div>

            <div class="space-y-6">
                <h2 class="text-[10px] font-black uppercase tracking-widest text-slate-400 border-b pb-2">Color Processing</h2>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Black Gen (K)</span><span id="kLimit-val" class="text-slate-400">0.5</span></div>
                    <input type="range" id="kLimit" min="0" max="1.0" step="0.05" value="0.5">
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Ink Opacity</span><span id="opacity-val" class="text-slate-400">0.9</span></div>
                    <input type="range" id="opacity" min="0.1" max="1.0" step="0.05" value="0.9">
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Contrast</span><span id="contrast-val" class="text-slate-400">1.0</span></div>
                    <input type="range" id="contrast" min="0.5" max="2.0" step="0.1" value="1.0">
                </div>
            </div>

            <div class="space-y-6">
                <h2 class="text-[10px] font-black uppercase tracking-widest text-slate-400 border-b pb-2">Halftone</h2>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Resolution</span><span id="frequency-val" class="text-slate-400">85</span></div>
                    <input type="range" id="frequency" min="30" max="200" value="85">
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Dot Size</span><span id="dotScale-val" class="text-slate-400">1.0</span></div>
                    <input type="range" id="dotScale" min="0.1" max="3.0" step="0.1" value="1.0">
                </div>
            </div>
        </div>

        <button id="download-btn" class="mt-8 w-full bg-slate-950 text-white text-[11px] font-bold tracking-widest uppercase py-4 rounded-xl hover:bg-black transition-transform active:scale-95">Download PNG</button>
    </aside>

    <main id="preview-container" class="flex-1 relative">
        <div id="canvas-wrapper">
            <canvas id="mainCanvas"></canvas>
            <p id="placeholder" class="absolute inset-0 flex items-center justify-center text-slate-300 font-bold uppercase tracking-widest text-[10px] pointer-events-none">Studio Empty</p>
        </div>

        <div class="fixed bottom-8 right-8 flex items-center bg-white/95 backdrop-blur shadow-2xl rounded-2xl p-1.5 border border-slate-200 z-50">
            <button id="zoom-in" title="Zoom In" class="p-2 hover:bg-slate-100 rounded-xl transition-colors text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </button>
            <button id="zoom-out" title="Zoom Out" class="p-2 hover:bg-slate-100 rounded-xl transition-colors text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </button>
            
            <div class="w-[1px] h-6 bg-slate-200 mx-1"></div>

            <select id="zoom-select" class="bg-transparent text-[11px] font-bold uppercase tracking-tight px-2 py-1 cursor-pointer focus:outline-none text-slate-700">
                <option value="0.25">25%</option>
                <option value="0.5">50%</option>
                <option value="0.75">75%</option>
                <option value="1" selected>100% (Fit)</option>
                <option value="1.5">150%</option>
                <option value="2">200%</option>
                <option value="4">400%</option>
                <option id="custom-zoom-opt" value="" hidden>Custom</option>
            </select>

            <div class="w-[1px] h-6 bg-slate-200 mx-1"></div>

            <button id="zoom-fit" title="Fit to Screen" class="p-2 hover:bg-slate-100 rounded-xl transition-colors text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h6v6M9 21H3v-6M21 15v6h-6M3 9V3h6"/></svg>
            </button>
        </div>
    </main>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const container = document.getElementById('preview-container');
        const zoomSelect = document.getElementById('zoom-select');
        const ctx = canvas.getContext('2d', { alpha: false });
        let sourceBitmap = null;
        let currentZoom = 1.0;
        
        let isDragging = false;
        let startX, startY, scrollLeft, scrollTop;

        const config = { 
            shadows: 0, highlights: 1.0, kLimit: 0.5, opacity: 0.9,
            contrast: 1.0, frequency: 85, dotScale: 1.0, threshold: 0.08 
        };

        const updateZoom = (val) => {
            currentZoom = parseFloat(val);
            // Sync dropdown display
            const found = Array.from(zoomSelect.options).some(opt => opt.value == currentZoom);
            if (found) {
                zoomSelect.value = currentZoom;
                document.getElementById('custom-zoom-opt').hidden = true;
            } else {
                const custom = document.getElementById('custom-zoom-opt');
                custom.textContent = `${Math.round(currentZoom * 100)}%`;
                custom.value = currentZoom;
                custom.hidden = false;
                zoomSelect.value = currentZoom;
            }
            render();
        };

        // Instant Panning Logic
        container.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            scrollLeft = container.scrollLeft;
            scrollTop = container.scrollTop;
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            container.scrollLeft = scrollLeft - dx;
            container.scrollTop = scrollTop - dy;
        });

        window.addEventListener('mouseup', () => isDragging = false);

        document.getElementById('zoom-in').onclick = () => updateZoom(currentZoom + 0.25);
        document.getElementById('zoom-out').onclick = () => updateZoom(Math.max(0.1, currentZoom - 0.25));
        document.getElementById('zoom-fit').onclick = () => updateZoom(1.0);
        zoomSelect.onchange = (e) => updateZoom(e.target.value);

        // Core Render Engine
        document.getElementById('img-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            sourceBitmap = await createImageBitmap(file);
            document.getElementById('placeholder').style.display = 'none';
            // Explicitly set initial view state to 100% Fit
            currentZoom = 1.0;
            zoomSelect.value = 1.0; 
            render();
        });

        ['shadows', 'highlights', 'kLimit', 'opacity', 'contrast', 'frequency', 'dotScale'].forEach(key => {
            const el = document.getElementById(key);
            if (el) {
                el.addEventListener('input', (e) => {
                    config[key] = parseFloat(e.target.value);
                    document.getElementById(`${key}-val`).textContent = config[key];
                    if (sourceBitmap) requestAnimationFrame(render);
                });
            }
        });

        window.addEventListener('resize', () => { if (sourceBitmap) render(); });

        function render() {
            if (!sourceBitmap) return;

            const sideWidth = 320;
            const viewportPadding = 160;
            const maxWidth = (window.innerWidth - sideWidth - viewportPadding);
            const maxHeight = (window.innerHeight - viewportPadding);
            const aspect = sourceBitmap.width / sourceBitmap.height;
            
            let baseW = maxWidth;
            let baseH = maxWidth / aspect;
            if (baseH > maxHeight) { baseH = maxHeight; baseW = maxHeight * aspect; }

            const displayW = baseW * currentZoom;
            const displayH = baseH * currentZoom;

            canvas.width = displayW;
            canvas.height = displayH;

            const buffer = document.createElement('canvas');
            buffer.width = displayW; buffer.height = displayH;
            const bCtx = buffer.getContext('2d');
            bCtx.drawImage(sourceBitmap, 0, 0, displayW, displayH);
            const imgData = bCtx.getImageData(0, 0, displayW, displayH).data;

            ctx.fillStyle = "#fdfaf0"; 
            ctx.fillRect(0, 0, displayW, displayH);
            ctx.globalCompositeOperation = 'multiply';

            const colors = [
                { name: 'c', color: '#00FFFF', angle: 15 },
                { name: 'm', color: '#FF00FF', angle: 75 },
                { name: 'y', color: '#FFFF00', angle: 0 },
                { name: 'k', color: '#000000', angle: 45 }
            ];

            const gridStep = baseW / config.frequency * currentZoom;
            const diag = Math.sqrt(displayW**2 + displayH**2);
            const gamma = 1.2;

            colors.forEach(ink => {
                ctx.globalAlpha = config.opacity;
                ctx.fillStyle = ink.color;
                const rad = ink.angle * (Math.PI / 180);
                const cosA = Math.cos(rad), sinA = Math.sin(rad);

                for (let gx = -diag; gx < diag; gx += gridStep) {
                    for (let gy = -diag; gy < diag; gy += gridStep) {
                        const centerX = displayW / 2, centerY = displayH / 2;
                        const x = gx * cosA - gy * sinA + centerX;
                        const y = gx * sinA + gy * cosA + centerY;

                        if (x >= 0 && x < displayW && y >= 0 && y < displayH) {
                            const i = (Math.floor(y) * Math.floor(displayW) + Math.floor(x)) * 4;
                            const vRaw = imgData[i] / 255;
                            const vRemapped = Math.pow((vRaw * (config.highlights - config.shadows)) + config.shadows, gamma);
                            const vContrast = Math.pow(vRemapped, config.contrast);

                            const r = Math.pow(imgData[i]/255, gamma), g = Math.pow(imgData[i+1]/255, gamma), b = Math.pow(imgData[i+2]/255, gamma);
                            const k = (1 - Math.max(r, g, b)) * config.kLimit; 

                            let val = 0;
                            if (ink.name === 'c') val = 1 - r - k;
                            else if (ink.name === 'm') val = 1 - g - k;
                            else if (ink.name === 'y') val = 1 - b - k;
                            else val = k;

                            if (val > 0) {
                                const radius = (gridStep / 1.5) * Math.sqrt(val) * config.dotScale;
                                ctx.beginPath();
                                ctx.arc(x, y, Math.max(0.1, radius), 0, Math.PI * 2);
                                ctx.fill();
                            }
                        }
                    }
                }
            });
            ctx.globalAlpha = 1.0;
        }

        document.getElementById('download-btn').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'halftone-pro-v2-6.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
    </script>
</body>
</html>
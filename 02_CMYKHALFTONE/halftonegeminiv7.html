<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halftone Engine v3.6 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f1f2; -webkit-font-smoothing: antialiased; }
        input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; }
        input[type=range]::-webkit-slider-runnable-track { height: 2px; background: #e5e7eb; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { height: 12px; width: 12px; border-radius: 50%; background: #111827; -webkit-appearance: none; margin-top: -5px; border: 2px solid #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer; }
        
        #preview-container { display: grid; place-items: center; overflow: auto; cursor: grab; user-select: none; background-color: #f4f4f5; width: 100%; height: 100vh; }
        #preview-container:active { cursor: grabbing; }
        #preview-container::-webkit-scrollbar { width: 6px; height: 6px; }
        #preview-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        #canvas-wrapper { padding: 120px; display: flex; align-items: center; justify-content: center; }
        canvas { box-shadow: 0 40px 80px -15px rgb(0 0 0 / 0.4); pointer-events: none; display: block; }
        
        .color-swatch { appearance: none; -webkit-appearance: none; border: none; width: 18px; height: 18px; border-radius: 4px; cursor: pointer; background: none; padding: 0; }
        .color-swatch::-webkit-color-swatch { border: 1px solid #e2e8f0; border-radius: 4px; }
        
        /* Zoom Panel Specifics */
        .zoom-panel-btn { @apply p-2 hover:bg-slate-100 rounded-lg transition-colors text-slate-600 flex items-center justify-center; }
        .zoom-panel-btn.active { @apply bg-slate-100 text-slate-900; }
    </style>
</head>
<body class="flex h-screen w-screen overflow-hidden text-slate-900">

    <aside class="w-80 flex-shrink-0 border-r border-slate-200 bg-white p-8 overflow-y-auto z-20 flex flex-col shadow-2xl">
        <h1 class="text-[10px] font-bold tracking-[0.3em] uppercase text-slate-400 mb-8">Halftone Engine Pro</h1>

        <label class="mb-8 group flex flex-col items-center justify-center w-full h-20 border-2 border-dashed border-slate-200 rounded-2xl cursor-pointer hover:border-slate-400 hover:bg-slate-50 transition-all">
            <span class="text-[11px] font-bold uppercase text-slate-500">Upload Image</span>
            <input id="img-upload" type="file" class="hidden" accept="image/*" />
        </label>

        <div class="space-y-8 flex-1">
            <div class="space-y-6">
                <h2 class="text-[10px] font-black uppercase tracking-widest text-slate-400 border-b pb-2">Tone & Blur</h2>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Blur</span><span id="blur-val" class="text-slate-400">0</span></div>
                    <input type="range" id="blur" min="0" max="10" step="0.5" value="0">
                </div>
                <div class="space-y-1 text-center">
                    <div class="flex justify-between text-[11px] font-bold uppercase mb-1"><span>Shadows</span><span id="shadows-val" class="text-slate-400">0.00</span></div>
                    <input type="range" id="shadows" min="-0.5" max="0.5" step="0.01" value="0">
                </div>
                <div class="space-y-1 text-center">
                    <div class="flex justify-between text-[11px] font-bold uppercase mb-1"><span>Highlights</span><span id="highlights-val" class="text-slate-400">1.00</span></div>
                    <input type="range" id="highlights" min="0.5" max="1.5" step="0.01" value="1.0">
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Contrast</span><span id="contrast-val" class="text-slate-400">1.0</span></div>
                    <input type="range" id="contrast" min="0.5" max="2.0" step="0.1" value="1.0">
                </div>
            </div>

            <div class="space-y-4">
                <h2 class="text-[10px] font-black uppercase tracking-widest text-slate-400 border-b pb-2">Palette & Strength</h2>
                <div class="grid grid-cols-1 gap-4">
                    <div class="flex flex-col gap-2 bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2"><input type="color" id="cColor" class="color-swatch" value="#00ffff"><span class="text-[10px] font-bold uppercase">Cyan</span></div>
                            <span id="cLimit-val" class="text-[10px] text-slate-400">1.0</span>
                        </div>
                        <input type="range" id="cLimit" min="0" max="1" step="0.05" value="1">
                    </div>
                    <div class="flex flex-col gap-2 bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2"><input type="color" id="mColor" class="color-swatch" value="#ff00ff"><span class="text-[10px] font-bold uppercase">Magenta</span></div>
                            <span id="mLimit-val" class="text-[10px] text-slate-400">1.0</span>
                        </div>
                        <input type="range" id="mLimit" min="0" max="1" step="0.05" value="1">
                    </div>
                    <div class="flex flex-col gap-2 bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2"><input type="color" id="yColor" class="color-swatch" value="#ffff00"><span class="text-[10px] font-bold uppercase">Yellow</span></div>
                            <span id="yLimit-val" class="text-[10px] text-slate-400">1.0</span>
                        </div>
                        <input type="range" id="yLimit" min="0" max="1" step="0.05" value="1">
                    </div>
                    <div class="flex flex-col gap-2 bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2"><input type="color" id="kColor" class="color-swatch" value="#000000"><span class="text-[10px] font-bold uppercase">Black (K)</span></div>
                            <span id="kLimit-val" class="text-[10px] text-slate-400">0.5</span>
                        </div>
                        <input type="range" id="kLimit" min="0" max="1" step="0.05" value="0.5">
                    </div>
                    <div class="flex items-center gap-3 bg-slate-100/50 p-3 rounded-xl border border-slate-200">
                        <input type="color" id="paperColor" class="color-swatch h-6" value="#fdfaf0">
                        <span class="text-[10px] font-bold uppercase">Paper Stock</span>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <h2 class="text-[10px] font-black uppercase tracking-widest text-slate-400 border-b pb-2">Halftone Physics</h2>
                
                <div class="flex items-center justify-between">
                    <span class="text-[11px] font-bold uppercase">Fill Highlights</span>
                    <input id="forceMinDot" type="checkbox" class="w-8 h-4 bg-slate-200 checked:bg-slate-900 rounded-full appearance-none cursor-pointer transition-colors"/>
                </div>

                <div class="space-y-1">
                    <div class="text-[11px] font-bold uppercase mb-1 text-slate-400">Ink Bleed (Irregularity)</div>
                    <select id="inkBleed" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-[11px] font-bold uppercase">
                        <option value="0">None</option>
                        <option value="0.1">Subtle</option>
                        <option value="0.2">Moderate</option>
                        <option value="0.3">Strong</option>
                    </select>
                </div>

                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Resolution</span><span id="frequency-val" class="text-slate-400">85</span></div>
                    <input type="range" id="frequency" min="30" max="200" value="85">
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Size Curve</span><span id="dotContrast-val" class="text-slate-400">1.00</span></div>
                    <input type="range" id="dotContrast" min="0.5" max="3.0" step="0.1" value="1.0">
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[11px] font-bold uppercase"><span>Global Scale</span><span id="dotScale-val" class="text-slate-400">1.00</span></div>
                    <input type="range" id="dotScale" min="0.1" max="3.0" step="0.1" value="1.0">
                </div>
            </div>
        </div>

        <button id="download-btn" class="mt-8 w-full bg-slate-950 text-white text-[11px] font-bold tracking-widest uppercase py-4 rounded-xl hover:bg-black active:scale-95 transition-all">Download PNG</button>
    </aside>

    <main id="preview-container" class="flex-1 relative">
        <div id="canvas-wrapper">
            <canvas id="mainCanvas"></canvas>
            <p id="placeholder" class="absolute inset-0 flex items-center justify-center text-slate-300 font-bold uppercase tracking-widest text-[10px] pointer-events-none">Studio Empty</p>
        </div>

        <div class="fixed bottom-8 right-8 flex items-center bg-white/90 backdrop-blur-md shadow-lg rounded-full px-2 py-1 border border-slate-200 z-50">
            <button id="zoom-in" class="zoom-panel-btn active">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </button>
            <button id="zoom-out" class="zoom-panel-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </button>
            
            <div class="w-[1px] h-6 bg-slate-200 mx-2"></div>

            <div class="relative flex items-center">
                <select id="zoom-select" class="bg-transparent text-[11px] font-black uppercase tracking-tight pl-2 pr-6 py-1 appearance-none cursor-pointer focus:outline-none text-slate-700">
                    <option value="0.25">25%</option>
                    <option value="0.5">50%</option>
                    <option value="0.75">75%</option>
                    <option value="1" selected>Fit</option>
                    <option value="2">200%</option>
                </select>
                <div class="absolute right-1 pointer-events-none text-slate-400">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M6 9l6 6 6-6"/></svg>
                </div>
            </div>

            <div class="w-[1px] h-6 bg-slate-200 mx-2"></div>

            <button id="zoom-fit" class="zoom-panel-btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 3h6v6M9 21H3v-6M21 15v6h-6M3 9V3h6"/></svg>
            </button>
        </div>
    </main>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const container = document.getElementById('preview-container');
        const zoomSelect = document.getElementById('zoom-select');
        const ctx = canvas.getContext('2d', { alpha: false });
        let sourceBitmap = null, currentZoom = 1.0;
        let isDragging = false, startX, startY, scrollLeft, scrollTop;

        const config = { 
            blur: 0, shadows: 0, highlights: 1.0, contrast: 1.0, 
            dotContrast: 1.0, frequency: 85, dotScale: 1.0,
            inkBleed: 0, cColor: "#00ffff", mColor: "#ff00ff", yColor: "#ffff00", kColor: "#000000", paperColor: "#fdfaf0",
            forceMinDot: false,
            cLimit: 1, mLimit: 1, yLimit: 1, kLimit: 0.5 // Channel Strength Initial
        };

        const seededRandom = (s) => {
            const t = s ^ (s >>> 16);
            return (Math.sin(t) + 1) / 2;
        };

        const updateZoom = (val) => {
            currentZoom = parseFloat(val);
            render();
        };

        container.onmousedown = (e) => { isDragging = true; startX = e.clientX; startY = e.clientY; scrollLeft = container.scrollLeft; scrollTop = container.scrollTop; };
        window.onmousemove = (e) => { if (!isDragging) return; container.scrollLeft = scrollLeft - (e.clientX - startX); container.scrollTop = scrollTop - (e.clientY - startY); };
        window.onmouseup = () => isDragging = false;

        document.getElementById('zoom-in').onclick = () => { 
            updateZoom(currentZoom + 0.25);
            document.getElementById('zoom-in').classList.add('active');
            document.getElementById('zoom-out').classList.remove('active');
        };
        document.getElementById('zoom-out').onclick = () => { 
            updateZoom(Math.max(0.1, currentZoom - 0.25));
            document.getElementById('zoom-out').classList.add('active');
            document.getElementById('zoom-in').classList.remove('active');
        };
        document.getElementById('zoom-fit').onclick = () => updateZoom(1.0);
        zoomSelect.onchange = (e) => updateZoom(e.target.value);

        document.getElementById('img-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if (!file) return;
            sourceBitmap = await createImageBitmap(file);
            document.getElementById('placeholder').style.display = 'none';
            render();
        });

        ['blur', 'shadows', 'highlights', 'contrast', 'dotContrast', 'frequency', 'dotScale', 'cColor', 'mColor', 'yColor', 'kColor', 'paperColor', 'cLimit', 'mLimit', 'yLimit', 'kLimit', 'inkBleed'].forEach(key => {
            const el = document.getElementById(key);
            if (el) {
                el.addEventListener('input', (e) => {
                    config[key] = (e.target.type === 'range') ? parseFloat(e.target.value) : e.target.value;
                    if (document.getElementById(`${key}-val`)) document.getElementById(`${key}-val`).textContent = parseFloat(e.target.value).toFixed(2);
                    if (sourceBitmap) requestAnimationFrame(render);
                });
            }
        });

        document.getElementById('forceMinDot').addEventListener('change', (e) => {
            config.forceMinDot = e.target.checked;
            if (sourceBitmap) requestAnimationFrame(render);
        });

        function render() {
            if (!sourceBitmap) return;
            const maxWidth = (window.innerWidth - 320 - 160), maxHeight = (window.innerHeight - 160);
            const aspect = sourceBitmap.width / sourceBitmap.height;
            let baseW = maxWidth, baseH = maxWidth / aspect;
            if (baseH > maxHeight) { baseH = maxHeight; baseW = maxHeight * aspect; }

            const displayW = baseW * currentZoom, displayH = baseH * currentZoom;
            canvas.width = displayW; canvas.height = displayH;

            const buffer = document.createElement('canvas');
            buffer.width = displayW; buffer.height = displayH;
            const bCtx = buffer.getContext('2d');
            if (config.blur > 0) bCtx.filter = `blur(${config.blur * currentZoom}px)`;
            bCtx.drawImage(sourceBitmap, 0, 0, displayW, displayH);
            const imgData = bCtx.getImageData(0, 0, displayW, displayH).data;

            ctx.fillStyle = config.paperColor;
            ctx.fillRect(0, 0, displayW, displayH);

            ctx.globalCompositeOperation = 'multiply';
            const colors = [
                {id:'c', col:config.cColor, ang:15, limit: config.cLimit}, 
                {id:'m', col:config.mColor, ang:75, limit: config.mLimit}, 
                {id:'y', col:config.yColor, ang:0, limit: config.yLimit}, 
                {id:'k', col:config.kColor, ang:45, limit: config.kLimit}
            ];

            const gridStep = baseW / config.frequency * currentZoom;
            const diag = Math.sqrt(displayW**2 + displayH**2);

            colors.forEach(ink => {
                ctx.fillStyle = ink.col;
                ctx.globalAlpha = 0.95;
                const rad = ink.ang * (Math.PI / 180), cosA = Math.cos(rad), sinA = Math.sin(rad);

                for (let gx = -diag; gx < diag; gx += gridStep) {
                    for (let gy = -diag; gy < diag; gy += gridStep) {
                        const centerX = displayW / 2, centerY = displayH / 2;
                        const x = gx * cosA - gy * sinA + centerX, y = gx * sinA + gy * cosA + centerY;
                        
                        if (x >= 0 && x < displayW && y >= 0 && y < displayH) {
                            const i = (Math.floor(y) * Math.floor(displayW) + Math.floor(x)) * 4;
                            let rV = (imgData[i]/255 - config.shadows) / (config.highlights - config.shadows);
                            let gV = (imgData[i+1]/255 - config.shadows) / (config.highlights - config.shadows);
                            let bV = (imgData[i+2]/255 - config.shadows) / (config.highlights - config.shadows);

                            const r = Math.pow(Math.max(0, Math.min(1, rV)), config.contrast * 1.2);
                            const g = Math.pow(Math.max(0, Math.min(1, gV)), config.contrast * 1.2);
                            const b = Math.pow(Math.max(0, Math.min(1, bV)), config.contrast * 1.2);

                            const k = 1 - Math.max(r, g, b);
                            let val = 0;
                            if (ink.id === 'c') val = 1-r-k; else if (ink.id === 'm') val = 1-g-k; else if (ink.id === 'y') val = 1-b-k; else val = k;

                            // Apply Individual Channel Strength (Limit)
                            val = val * ink.limit;

                            const density = Math.pow(val, config.dotContrast);
                            let radius = (gridStep / 1.5) * Math.sqrt(density) * config.dotScale;

                            if (config.forceMinDot) radius = Math.max(radius, (gridStep / 1.5) * 0.15 * config.dotScale);
                            else if (val <= 0.05) radius = 0;

                            if (radius > 0) {
                                if (config.inkBleed > 0) {
                                    const segments = 10;
                                    ctx.beginPath();
                                    for (let s = 0; s <= segments; s++) {
                                        const angle = (s / segments) * Math.PI * 2;
                                        const jitter = (seededRandom(gx + gy + s + ink.ang) - 0.5) * config.inkBleed * 5;
                                        const rJitter = radius + jitter;
                                        const sx = x + Math.cos(angle) * rJitter;
                                        const sy = y + Math.sin(angle) * rJitter;
                                        if (s === 0) ctx.moveTo(sx, sy);
                                        else ctx.lineTo(sx, sy);
                                    }
                                    ctx.closePath();
                                    ctx.fill();
                                } else {
                                    ctx.beginPath();
                                    ctx.arc(x, y, radius, 0, Math.PI * 2);
                                    ctx.fill();
                                }
                            }
                        }
                    }
                }
            });
            ctx.globalAlpha = 1.0;
        }

        document.getElementById('download-btn').onclick = () => {
            const link = document.createElement('a'); link.download = 'halftone-pro-export.png';
            link.href = canvas.toDataURL('image/png'); link.click();
        };
    </script>
</body>
</html>
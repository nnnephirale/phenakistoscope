<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mandarin Image Translator</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --background: #fafafa;
            --foreground: #0a0a0a;
            --card: #ffffff;
            --card-foreground: #0a0a0a;
            --muted: #f4f4f5;
            --muted-foreground: #71717a;
            --border: #e4e4e7;
            --ring: #18181b;
            --radius: 0.5rem;
            --accent: #2563eb;
            --accent-light: #dbeafe;
        }

        body {
            font-family: 'Geist', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--background);
            color: var(--foreground);
            min-height: 100vh;
            line-height: 1.5;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Row 1: Upload */
        .upload-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .upload-label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            background: var(--foreground);
            color: var(--background);
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .upload-label:hover {
            opacity: 0.9;
        }

        .upload-label svg {
            width: 1rem;
            height: 1rem;
        }

        #file-input {
            display: none;
        }

        .file-name {
            font-size: 0.875rem;
            color: var(--muted-foreground);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Row 2: Preview */
        .preview-row {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-placeholder {
            color: var(--muted-foreground);
            font-size: 0.875rem;
        }

        .preview-image {
            max-width: 100%;
            max-height: 120px;
            border-radius: calc(var(--radius) - 4px);
            object-fit: contain;
        }

        /* Row 3: Translation */
        .translation-row {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            min-height: 500px;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .translation-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .translation-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--muted-foreground);
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 2rem;
            padding: 0 0.75rem;
            border: 1px solid var(--border);
            background: var(--background);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.75rem;
            font-family: inherit;
            color: var(--foreground);
            gap: 0.375rem;
        }

        .action-btn.icon-only {
            width: 2rem;
            padding: 0;
        }

        .action-btn.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .action-btn:hover {
            background: var(--muted);
        }

        .action-btn.active {
            background: var(--foreground);
            color: var(--background);
            border-color: var(--foreground);
        }

        .action-btn svg {
            width: 0.875rem;
            height: 0.875rem;
        }

        /* Zoom slider */
        .zoom-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            opacity: 0.5;
            pointer-events: none;
        }

        .zoom-control.active {
            opacity: 1;
            pointer-events: auto;
        }

        .zoom-control svg {
            width: 0.875rem;
            height: 0.875rem;
            color: var(--muted-foreground);
        }

        .zoom-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 80px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: var(--foreground);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s ease;
        }

        .zoom-slider::-webkit-slider-thumb:hover {
            transform: scale(1.15);
        }

        .zoom-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: var(--foreground);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .zoom-value {
            font-size: 0.6875rem;
            color: var(--muted-foreground);
            min-width: 2.5rem;
            text-align: right;
        }

        .translation-content {
            flex: 1;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: auto;
        }

        .translation-placeholder {
            color: var(--muted-foreground);
            font-size: 0.875rem;
            text-align: center;
            margin: auto;
        }

        /* Interactive image container */
        .interactive-image-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
        }

        .interactive-image-container {
            position: relative;
            display: inline-block;
            cursor: crosshair;
        }

        .interactive-image-container img {
            width: 100%;
            height: auto;
            border-radius: var(--radius);
            display: block;
            user-select: none;
        }

        .interactive-image-container {
            max-width: var(--image-scale, 50%);
            transition: max-width 0.15s ease;
        }

        .click-hint {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--muted-foreground);
            padding: 0.5rem 0.75rem;
            background: var(--muted);
            border-radius: var(--radius);
        }

        .click-hint svg {
            width: 0.875rem;
            height: 0.875rem;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: var(--foreground);
            color: var(--background);
            padding: 0.625rem 0.875rem;
            border-radius: var(--radius);
            font-size: 0.8125rem;
            max-width: 280px;
            z-index: 50;
            pointer-events: none;
            opacity: 0;
            transform: translateY(4px);
            transition: opacity 0.15s ease, transform 0.15s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .tooltip-chinese {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-bottom: 0.25rem;
        }

        .tooltip-english {
            font-weight: 500;
            line-height: 1.4;
        }

        .tooltip-arrow {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--foreground);
            transform: rotate(45deg);
        }

        .tooltip-arrow.top {
            bottom: -4px;
            left: 50%;
            margin-left: -4px;
        }

        .tooltip-arrow.bottom {
            top: -4px;
            left: 50%;
            margin-left: -4px;
        }

        /* Translations list panel */
        .translations-panel {
            width: 100%;
            margin-top: 1rem;
            border-top: 1px solid var(--border);
            padding-top: 1rem;
            display: none;
        }

        .translations-panel.visible {
            display: block;
        }

        .translations-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .translations-panel-title {
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--muted-foreground);
        }

        .translations-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .translation-item {
            display: flex;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--muted);
            border-radius: var(--radius);
            align-items: flex-start;
            transition: background 0.15s ease;
        }

        .translation-item:hover {
            background: var(--accent-light);
        }

        .translation-item.highlighted {
            background: var(--accent-light);
            box-shadow: inset 0 0 0 2px var(--accent);
        }

        .translation-number {
            width: 1.25rem;
            height: 1.25rem;
            min-width: 1.25rem;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.625rem;
            font-weight: 600;
        }

        .translation-text {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .chinese-text {
            font-size: 0.875rem;
            color: var(--muted-foreground);
        }

        .english-text {
            font-size: 0.9375rem;
            font-weight: 500;
        }

        /* Loading state */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin: auto;
        }

        .spinner {
            width: 2rem;
            height: 2rem;
            border: 2px solid var(--border);
            border-top-color: var(--foreground);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 0.875rem;
            color: var(--muted-foreground);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 2rem;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal-content {
            position: relative;
            max-width: 95vw;
            max-height: 95vh;
            overflow: auto;
        }

        .modal-image-container {
            position: relative;
            display: inline-block;
            cursor: crosshair;
        }

        .modal-image {
            max-width: 90vw;
            max-height: 85vh;
            border-radius: var(--radius);
            object-fit: contain;
            user-select: none;
        }

        .modal-close {
            position: fixed;
            top: 1rem;
            right: 1rem;
            width: 2.5rem;
            height: 2.5rem;
            border: none;
            background: rgba(255, 255, 255, 0.15);
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .modal-close svg {
            width: 1.25rem;
            height: 1.25rem;
            color: white;
        }

        .modal-tooltip {
            position: absolute;
            background: white;
            color: var(--foreground);
            padding: 0.625rem 0.875rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            max-width: 320px;
            z-index: 50;
            pointer-events: none;
            opacity: 0;
            transform: translateY(4px);
            transition: opacity 0.15s ease, transform 0.15s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .modal-tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Error state */
        .error {
            color: #ef4444;
            font-size: 0.875rem;
            text-align: center;
            margin: auto;
        }

        /* No text found */
        .no-text {
            text-align: center;
            color: var(--muted-foreground);
            margin: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Row 1: Upload -->
        <div class="upload-row">
            <label class="upload-label" for="file-input">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                Upload Image
            </label>
            <input type="file" id="file-input" accept="image/*">
            <span class="file-name" id="file-name"></span>
        </div>

        <!-- Row 2: Preview -->
        <div class="preview-row">
            <span class="preview-placeholder" id="preview-placeholder">No image uploaded</span>
            <img class="preview-image" id="preview-image" style="display: none;">
        </div>

        <!-- Row 3: Translation -->
        <div class="translation-row">
            <div class="translation-header">
                <span class="translation-title">Translated Image</span>
                <div class="header-actions">
                    <button class="action-btn disabled" id="show-all-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="8" y1="6" x2="21" y2="6"/>
                            <line x1="8" y1="12" x2="21" y2="12"/>
                            <line x1="8" y1="18" x2="21" y2="18"/>
                            <line x1="3" y1="6" x2="3.01" y2="6"/>
                            <line x1="3" y1="12" x2="3.01" y2="12"/>
                            <line x1="3" y1="18" x2="3.01" y2="18"/>
                        </svg>
                        Show All
                    </button>
                    <div class="zoom-control" id="zoom-control">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                        </svg>
                        <input type="range" class="zoom-slider" id="zoom-slider" min="30" max="100" value="50">
                        <span class="zoom-value" id="zoom-value">50%</span>
                    </div>
                    <button class="action-btn icon-only disabled" id="fullscreen-btn" title="View full screen">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="translation-content" id="translation-content">
                <span class="translation-placeholder">Upload an image to see translation</span>
            </div>
        </div>
    </div>

    <!-- Modal for full-size view -->
    <div class="modal-overlay" id="modal">
        <button class="modal-close" id="modal-close">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
        <div class="modal-content" id="modal-content"></div>
    </div>

    <script>
        const fileInput = document.getElementById('file-input');
        const fileName = document.getElementById('file-name');
        const previewPlaceholder = document.getElementById('preview-placeholder');
        const previewImage = document.getElementById('preview-image');
        const translationContent = document.getElementById('translation-content');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const showAllBtn = document.getElementById('show-all-btn');
        const zoomControl = document.getElementById('zoom-control');
        const zoomSlider = document.getElementById('zoom-slider');
        const zoomValue = document.getElementById('zoom-value');
        const modal = document.getElementById('modal');
        const modalClose = document.getElementById('modal-close');
        const modalContent = document.getElementById('modal-content');

        let currentTranslations = [];
        let currentImageSrc = null;
        let showAllVisible = false;
        let currentZoom = 50;

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            fileName.textContent = file.name;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Data = e.target.result;
                previewImage.src = base64Data;
                previewImage.style.display = 'block';
                previewPlaceholder.style.display = 'none';
                currentImageSrc = base64Data;

                await translateImage(base64Data);
            };
            reader.readAsDataURL(file);
        });

        async function translateImage(base64Image) {
            translationContent.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <span class="loading-text">Detecting and translating text...</span>
                </div>
            `;
            
            magnifyBtn.classList.add('disabled');
            showAllBtn.classList.add('disabled');
            showAllBtn.classList.remove('active');
            zoomControl.classList.remove('active');
            showAllVisible = false;

            try {
                const base64Data = base64Image.split(',')[1];
                const mediaType = base64Image.split(';')[0].split(':')[1];

                // Add timeout controller
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    signal: controller.signal,
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 4096,
                        messages: [{
                            role: 'user',
                            content: [
                                {
                                    type: 'image',
                                    source: {
                                        type: 'base64',
                                        media_type: mediaType,
                                        data: base64Data
                                    }
                                },
                                {
                                    type: 'text',
                                    text: `Analyze this image and identify ALL Mandarin Chinese text visible in it.

For each distinct text block/phrase, provide in reading order (top to bottom, left to right):
1. "chinese": The original Chinese text exactly as shown
2. "english": A clear, natural English translation
3. "x": The CENTER x-position as a percentage (0-100) from left edge
4. "y": The CENTER y-position as a percentage (0-100) from top edge

Be precise with positions - estimate where the CENTER of each text block is located.

Return ONLY a valid JSON array in reading order, no markdown, no explanation:
[{"chinese": "中文", "english": "Chinese", "x": 50, "y": 30}]

If no Chinese text is found, return: []`
                                }
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', response.status, errorText);
                    throw new Error(`API request failed: ${response.status}`);
                }

                clearTimeout(timeoutId);

                const data = await response.json();
                console.log('API Response:', data);
                
                const textContent = data.content
                    .filter(c => c.type === 'text')
                    .map(c => c.text)
                    .join('') || '[]';
                
                let translations;
                try {
                    const jsonMatch = textContent.match(/\[[\s\S]*\]/);
                    translations = jsonMatch ? JSON.parse(jsonMatch[0]) : [];
                } catch (parseError) {
                    console.error('Parse error:', parseError);
                    translations = [];
                }

                currentTranslations = translations;
                
                if (translations.length === 0) {
                    translationContent.innerHTML = `
                        <div class="no-text">
                            <p>No Chinese text detected in this image.</p>
                        </div>
                    `;
                    return;
                }

                fullscreenBtn.classList.remove('disabled');
                showAllBtn.classList.remove('disabled');
                zoomControl.classList.add('active');
                
                renderInteractiveView();

            } catch (error) {
                console.error('Translation error:', error);
                let errorMessage = error.message;
                if (error.name === 'AbortError') {
                    errorMessage = 'Request timed out. Please try again.';
                }
                translationContent.innerHTML = `
                    <div class="error">
                        <p>Failed to translate image.</p>
                        <p style="font-size: 0.75rem; margin-top: 0.5rem; opacity: 0.7;">${errorMessage}</p>
                        <button class="action-btn" style="margin-top: 1rem;" onclick="translateImage(currentImageSrc)">Try Again</button>
                    </div>
                `;
            }
        }

        function renderInteractiveView() {
            const wrapper = document.createElement('div');
            wrapper.className = 'interactive-image-wrapper';

            // Image container
            const container = document.createElement('div');
            container.className = 'interactive-image-container';
            container.id = 'image-container';
            container.style.setProperty('--image-scale', `${currentZoom}%`);
            
            const img = document.createElement('img');
            img.src = currentImageSrc;
            container.appendChild(img);

            // Tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.innerHTML = `
                <div class="tooltip-arrow top"></div>
                <div class="tooltip-chinese"></div>
                <div class="tooltip-english"></div>
            `;
            container.appendChild(tooltip);

            // Click handler
            container.addEventListener('click', (e) => {
                const rect = img.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                
                const nearest = findNearestTranslation(x, y);
                if (nearest) {
                    showTooltip(tooltip, img, nearest, e.clientX - rect.left, e.clientY - rect.top);
                    highlightListItem(nearest.index);
                }
            });

            // Hide tooltip when mouse leaves
            container.addEventListener('mouseleave', () => {
                tooltip.classList.remove('visible');
            });

            wrapper.appendChild(container);

            // Click hint
            const hint = document.createElement('div');
            hint.className = 'click-hint';
            hint.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/>
                </svg>
                Click anywhere on the image to reveal translations
            `;
            wrapper.appendChild(hint);

            // Translations panel (hidden by default)
            const panel = document.createElement('div');
            panel.className = 'translations-panel';
            panel.id = 'translations-panel';
            
            const panelHeader = document.createElement('div');
            panelHeader.className = 'translations-panel-header';
            panelHeader.innerHTML = `<span class="translations-panel-title">All Translations (${currentTranslations.length})</span>`;
            panel.appendChild(panelHeader);

            const list = document.createElement('div');
            list.className = 'translations-list';

            currentTranslations.forEach((t, index) => {
                const item = document.createElement('div');
                item.className = 'translation-item';
                item.dataset.index = index;
                item.innerHTML = `
                    <div class="translation-number">${index + 1}</div>
                    <div class="translation-text">
                        <div class="chinese-text">${escapeHtml(t.chinese)}</div>
                        <div class="english-text">${escapeHtml(t.english)}</div>
                    </div>
                `;
                list.appendChild(item);
            });

            panel.appendChild(list);
            wrapper.appendChild(panel);

            translationContent.innerHTML = '';
            translationContent.appendChild(wrapper);
        }

        function findNearestTranslation(clickX, clickY) {
            let nearest = null;
            let minDistance = Infinity;

            currentTranslations.forEach((t, index) => {
                const distance = Math.sqrt(
                    Math.pow(clickX - t.x, 2) + Math.pow(clickY - t.y, 2)
                );
                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = { ...t, index };
                }
            });

            return nearest;
        }

        function showTooltip(tooltip, img, translation, clickX, clickY) {
            const chineseEl = tooltip.querySelector('.tooltip-chinese');
            const englishEl = tooltip.querySelector('.tooltip-english');
            const arrow = tooltip.querySelector('.tooltip-arrow');
            
            chineseEl.textContent = translation.chinese;
            englishEl.textContent = translation.english;

            // Position tooltip
            const imgRect = img.getBoundingClientRect();
            const tooltipWidth = 280;
            const tooltipHeight = tooltip.offsetHeight || 60;
            
            let left = clickX - tooltipWidth / 2;
            let top = clickY - tooltipHeight - 12;
            let arrowPosition = 'top';

            // Keep within image bounds
            if (left < 8) left = 8;
            if (left + tooltipWidth > imgRect.width - 8) left = imgRect.width - tooltipWidth - 8;
            
            // Flip to bottom if not enough space above
            if (top < 8) {
                top = clickY + 12;
                arrowPosition = 'bottom';
            }

            tooltip.style.left = `${left}px`;
            tooltip.style.top = `${top}px`;
            tooltip.style.width = `${tooltipWidth}px`;
            
            arrow.className = `tooltip-arrow ${arrowPosition}`;
            
            tooltip.classList.add('visible');
        }

        function highlightListItem(index) {
            const panel = document.getElementById('translations-panel');
            if (!panel || !panel.classList.contains('visible')) return;

            // Remove previous highlight
            panel.querySelectorAll('.translation-item').forEach(item => {
                item.classList.remove('highlighted');
            });

            // Add highlight to current
            const item = panel.querySelector(`[data-index="${index}"]`);
            if (item) {
                item.classList.add('highlighted');
                item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Show All button
        showAllBtn.addEventListener('click', () => {
            if (showAllBtn.classList.contains('disabled')) return;
            
            const panel = document.getElementById('translations-panel');
            if (panel) {
                showAllVisible = !showAllVisible;
                panel.classList.toggle('visible', showAllVisible);
                showAllBtn.classList.toggle('active', showAllVisible);
            }
        });

        // Zoom slider
        zoomSlider.addEventListener('input', (e) => {
            currentZoom = parseInt(e.target.value);
            zoomValue.textContent = `${currentZoom}%`;
            
            const container = document.getElementById('image-container');
            if (container) {
                container.style.setProperty('--image-scale', `${currentZoom}%`);
            }
        });

        // Fullscreen button - open modal
        fullscreenBtn.addEventListener('click', () => {
            if (fullscreenBtn.classList.contains('disabled')) return;
            openModal();
        });

        function openModal() {
            if (!currentImageSrc) return;

            modalContent.innerHTML = '';
            
            const container = document.createElement('div');
            container.className = 'modal-image-container';
            
            const img = document.createElement('img');
            img.src = currentImageSrc;
            img.className = 'modal-image';
            container.appendChild(img);

            // Modal tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'modal-tooltip';
            tooltip.innerHTML = `
                <div class="tooltip-chinese"></div>
                <div class="tooltip-english" style="font-weight: 500;"></div>
            `;
            container.appendChild(tooltip);

            // Click handler for modal
            container.addEventListener('click', (e) => {
                if (e.target === img) {
                    const rect = img.getBoundingClientRect();
                    const x = ((e.clientX - rect.left) / rect.width) * 100;
                    const y = ((e.clientY - rect.top) / rect.height) * 100;
                    
                    const nearest = findNearestTranslation(x, y);
                    if (nearest) {
                        showModalTooltip(tooltip, img, nearest, e.clientX - rect.left, e.clientY - rect.top);
                    }
                }
            });

            container.addEventListener('mouseleave', () => {
                tooltip.classList.remove('visible');
            });

            modalContent.appendChild(container);
            modal.classList.add('open');
        }

        function showModalTooltip(tooltip, img, translation, clickX, clickY) {
            const chineseEl = tooltip.querySelector('.tooltip-chinese');
            const englishEl = tooltip.querySelector('.tooltip-english');
            
            chineseEl.textContent = translation.chinese;
            chineseEl.style.fontSize = '0.8125rem';
            chineseEl.style.opacity = '0.7';
            chineseEl.style.marginBottom = '0.25rem';
            englishEl.textContent = translation.english;

            const imgRect = img.getBoundingClientRect();
            const tooltipWidth = 320;
            
            let left = clickX - tooltipWidth / 2;
            let top = clickY - 80;

            if (left < 8) left = 8;
            if (left + tooltipWidth > imgRect.width - 8) left = imgRect.width - tooltipWidth - 8;
            if (top < 8) top = clickY + 20;

            tooltip.style.left = `${left}px`;
            tooltip.style.top = `${top}px`;
            tooltip.style.width = `${tooltipWidth}px`;
            
            tooltip.classList.add('visible');
        }

        modalClose.addEventListener('click', () => {
            modal.classList.remove('open');
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('open');
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.classList.contains('open')) {
                modal.classList.remove('open');
            }
        });
    </script>
</body>
</html>